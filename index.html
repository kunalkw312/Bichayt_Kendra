<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bichayt Kendra Manager</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Manage Bichayt Kendra Bills and Customers">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* === PRINT STYLES (A4 Optimization) === */
        @media print {
            @page { size: A4; margin: 5mm; }
            body, html { 
                background-color: white; height: 100%; margin: 0; padding: 0; font-size: 11pt;
            }
            .no-print, #tab-nav, #settings-modal, #toast, button { display: none !important; }
            #main-container { 
                box-shadow: none !important; border: 2px solid black !important;
                width: 100% !important; max-width: 100% !important; margin: 0 !important;
            }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color: black !important; }
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
            .p-4, .p-6, .p-8 { padding: 10px !important; }
            .mb-6 { margin-bottom: 8px !important; }
            .mt-12 { margin-top: 10px !important; }
            .pt-8 { padding-top: 10px !important; }
            .gap-4 { gap: 8px !important; }
            .bg-blue-600 { background-color: #f0f0f0 !important; border-bottom: 2px solid black; padding: 10px !important; }
            .bg-yellow-50, .bg-blue-50, .bg-gray-50 { background-color: transparent !important; border: 1px solid #ccc !important; padding: 8px !important; }
            input { border: none !important; background: transparent !important; padding: 0 !important; height: auto !important; }
            ::placeholder { color: transparent; }
            h1 { font-size: 18pt !important; }
            h3 { font-size: 12pt !important; margin-bottom: 4px !important; }
            .text-xl { font-size: 14pt !important; }
            .text-lg { font-size: 12pt !important; }
            .text-sm { font-size: 10pt !important; }
            .text-xs { font-size: 9pt !important; }
            .tax-input { display: none; }
            .tax-label-print { display: inline !important; }
        }
        .tax-label-print { display: none; }
    </style>
</head>
<body>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-4 rounded-lg shadow-2xl text-white font-bold hidden transition-all duration-300 z-[100] no-print flex items-center gap-3 min-w-[300px] justify-center">
        <i id="toast-icon" class="text-xl"></i>
        <span id="toast-message" class="text-sm"></span>
    </div>

    <!-- SETTINGS -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 no-print px-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <h2 class="text-xl font-bold mb-4">Settings</h2>
            <label class="block text-sm font-medium text-gray-700 mb-2">Google Web App URL</label>
            <input type="text" id="script-url" class="w-full p-2 border rounded mb-4 text-sm" placeholder="https://script.google.com/macros/s/...">
            <div class="flex justify-end gap-2">
                <button onclick="toggleSettings()" class="px-4 py-2 text-gray-600">Cancel</button>
                <button onclick="saveSettings()" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
            </div>
        </div>
    </div>

    <div class="min-h-screen p-3 md:p-8 flex flex-col">
        
        <!-- HEADER -->
        <div class="max-w-4xl w-full mx-auto mb-4 flex justify-between items-center no-print px-2">
            <h1 class="text-xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-store text-blue-600 mr-2"></i>
                <span class="hidden sm:inline">Bichayt Kendra</span>
                <span class="sm:hidden">Bichayt</span>
            </h1>
            <div class="flex gap-2">
                <!-- Install Button (Hidden by default, shown by JS if installable) -->
                <button id="btn-install" class="hidden text-blue-600 font-bold text-sm bg-blue-50 px-3 py-1 rounded-full"><i class="fas fa-download mr-1"></i> Install App</button>
                <button onclick="toggleSettings()" class="text-gray-500 p-2"><i class="fas fa-cog text-xl"></i></button>
            </div>
        </div>

        <!-- TABS -->
        <div id="tab-nav" class="max-w-4xl w-full mx-auto mb-4 flex gap-2 no-print">
            <button onclick="switchTab('new')" id="tab-new" class="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold shadow transition text-sm md:text-base">
                <i class="fas fa-plus mr-1 md:mr-2"></i> New Bill
            </button>
            <button onclick="switchTab('search')" id="tab-search" class="flex-1 py-3 bg-white text-gray-600 rounded-lg font-bold shadow transition hover:bg-gray-50 text-sm md:text-base">
                <i class="fas fa-search mr-1 md:mr-2"></i> Search Bills
            </button>
        </div>

        <!-- === VIEW 1: NEW BILL === -->
        <div id="view-new-bill">
            <div id="main-container" class="max-w-4xl w-full mx-auto bg-white shadow-xl rounded-xl overflow-hidden print-border relative bg-white flex-grow">
                <!-- INVOICE HEADER -->
                <div class="bg-blue-600 p-6 text-white">
                    <div class="flex justify-between items-start">
                        <div>
                            <h1 class="text-2xl font-bold uppercase tracking-wider">Invoice</h1>
                            <p class="opacity-90 text-sm mt-1">Bichayt Kendra & Events</p>
                        </div>
                        <div class="text-right">
                            <div class="text-sm opacity-90 font-mono" id="current-date">Date: ...</div>
                        </div>
                    </div>
                </div>

                <div class="p-4 md:p-8">
                    <!-- Customer & Dates -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Customer Name</label>
                                <input type="text" id="cust-name" class="w-full text-lg font-medium border-b-2 border-gray-200 focus:border-blue-500 outline-none py-1">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Phone Number</label>
                                <input type="number" id="cust-phone" class="w-full text-lg font-medium border-b-2 border-gray-200 focus:border-blue-500 outline-none py-1">
                            </div>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                            <label class="block text-xs font-bold text-yellow-800 uppercase mb-2">Rental Period</label>
                            <div class="flex flex-col sm:flex-row gap-2 mb-2">
                                <div class="w-full sm:w-1/2">
                                    <span class="text-[10px] text-gray-500">Start Date</span>
                                    <input type="date" id="start-date" onchange="calcDays()" class="w-full bg-white border rounded p-2 text-base">
                                </div>
                                <div class="w-full sm:w-1/2">
                                    <span class="text-[10px] text-gray-500">End Date</span>
                                    <input type="date" id="end-date" onchange="calcDays()" class="w-full bg-white border rounded p-2 text-base">
                                </div>
                            </div>
                            <div class="text-right border-t border-yellow-200 pt-1">
                                <span class="text-xs text-gray-600">Total Duration:</span>
                                <span class="text-lg font-bold text-yellow-900 ml-2"><span id="total-days">1</span> Days</span>
                            </div>
                        </div>
                    </div>

                    <!-- MANDAP -->
                    <div class="bg-blue-50 rounded-lg p-4 mb-6 border border-blue-100">
                        <h3 class="font-bold text-blue-800 mb-3 flex items-center text-sm uppercase"><i class="fas fa-campground mr-2"></i> Mandap (Per Day)</h3>
                        <div class="grid grid-cols-3 gap-2 items-end">
                            <div><label class="block text-xs text-gray-600 mb-1">Length</label><input type="number" id="mandap-l" value="0" oninput="recalcAll()" class="w-full p-2 border rounded bg-white text-center text-lg"></div>
                            <div class="flex items-center justify-center pb-2 text-gray-400 font-bold">X</div>
                            <div><label class="block text-xs text-gray-600 mb-1">Width</label><input type="number" id="mandap-w" value="0" oninput="recalcAll()" class="w-full p-2 border rounded bg-white text-center text-lg"></div>
                        </div>
                        <div class="mt-3 flex justify-between items-center border-t border-blue-200 pt-3">
                            <div class="text-xs text-blue-700"><div id="mandap-details">Size: 0x0 (0 sq.ft)</div></div>
                            <div class="text-lg font-bold text-blue-900">₹ <span id="mandap-price">0</span></div>
                        </div>
                    </div>

                    <!-- ITEMS -->
                    <div class="mb-6">
                        <h3 class="font-bold text-gray-800 mb-2 text-sm uppercase">Items (Per Day)</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-[500px]"><tbody id="items-list"></tbody></table>
                        </div>
                        <div class="mt-4 flex gap-2 no-print bg-gray-50 p-3 rounded-lg border border-dashed border-gray-300 items-center">
                            <input type="text" id="new-item-name" placeholder="Item Name" class="flex-1 p-2 border rounded text-base w-full">
                            <input type="number" id="new-item-price" placeholder="₹" class="w-20 p-2 border rounded text-base">
                            <button onclick="addNewItem()" class="bg-green-600 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-green-700 flex-shrink-0"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>

                    <!-- TOTALS -->
                    <div class="flex justify-end border-t border-gray-200 pt-4">
                        <div class="w-full md:w-1/2">
                            <div class="flex justify-between mb-2 text-sm text-gray-500 italic"><span>Cost Per Day</span><span>₹ <span id="daily-total">0</span></span></div>
                            <div class="flex justify-between mb-2 text-sm text-gray-800 font-medium border-b border-gray-200 pb-2"><span>x <span id="days-display">1</span> Days</span><span>₹ <span id="subtotal">0</span></span></div>
                            <div class="flex justify-between mb-1 text-sm text-gray-600 items-center">
                                <div class="flex items-center"><span>CGST</span><input type="number" id="cgst-rate" value="9" readonly class="tax-input w-10 text-center border-b border-gray-300 mx-1 text-xs bg-gray-100 text-gray-500"><span class="tax-label-print ml-1 text-xs">(<span id="cgst-print-rate">9</span>%)</span></div>
                                <span>+ ₹ <span id="cgst-amt">0</span></span>
                            </div>
                            <div class="flex justify-between mb-2 text-sm text-gray-600 items-center">
                                 <div class="flex items-center"><span>SGST</span><input type="number" id="sgst-rate" value="9" readonly class="tax-input w-10 text-center border-b border-gray-300 mx-1 text-xs bg-gray-100 text-gray-500"><span class="tax-label-print ml-1 text-xs">(<span id="sgst-print-rate">9</span>%)</span></div>
                                <span>+ ₹ <span id="sgst-amt">0</span></span>
                            </div>
                            <div class="flex justify-between mt-3 pt-3 border-t-2 border-gray-800 text-xl font-bold text-gray-900"><span>Grand Total</span><span>₹ <span id="final-total">0</span></span></div>
                        </div>
                    </div>

                    <!-- FOOTER -->
                    <div class="mt-12 pt-8 border-t border-gray-200 text-center hidden print:block">
                        <p class="text-xs text-gray-500 mb-8">Please pay before due date. Thank you!</p>
                        <div class="flex justify-between px-8"><div class="border-t border-black w-24 pt-1 text-[10px]">Customer Sign</div><div class="border-t border-black w-24 pt-1 text-[10px]">Shop Owner Sign</div></div>
                    </div>
                </div>
            </div>

            <!-- PRINT BUTTON -->
            <div class="max-w-4xl w-full mx-auto mt-6 no-print pb-12">
                <button onclick="printAndSave()" id="btn-print" class="w-full bg-blue-600 text-white py-4 rounded-xl shadow-lg font-bold text-lg flex items-center justify-center hover:bg-blue-700 active:scale-95 transition-transform">
                    <i class="fas fa-print mr-3"></i> Print & Save Bill
                </button>
            </div>
        </div>

        <!-- === VIEW 2: SEARCH === -->
        <div id="view-search" class="hidden max-w-4xl w-full mx-auto">
            <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Search Old Bills</h2>
                <div class="flex gap-2">
                    <input type="text" id="search-query" class="flex-1 border p-3 rounded-lg text-base" placeholder="Name or Phone...">
                    <button onclick="performSearch()" id="btn-search" class="bg-blue-600 text-white px-6 rounded-lg font-bold">Search</button>
                </div>
            </div>
            <div id="search-results" class="space-y-4 pb-12"><div class="text-center text-gray-400 mt-12">Search to see records...</div></div>
        </div>

    </div>

    <script>
        const STANDARD_RATE = 1500;
        const STANDARD_AREA = 15 * 15; 
        let items = [ { id: 1, name: 'Mattress (Gadda)', price: 50, qty: 0 }, { id: 2, name: 'Pillow', price: 20, qty: 0 }, { id: 3, name: 'Bedsheet', price: 30, qty: 0 }, { id: 4, name: 'Plastic Chair', price: 10, qty: 0 } ];
        
        // PWA Installation Logic
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const installBtn = document.getElementById('btn-install');
            installBtn.classList.remove('hidden');
            installBtn.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') { installBtn.classList.add('hidden'); }
                    deferredPrompt = null;
                });
            });
        });

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW failed', err));
            });
        }

        window.onload = function() {
            document.getElementById('current-date').innerText = new Date().toLocaleString('en-GB');
            const savedUrl = localStorage.getItem('scriptUrl');
            if(savedUrl) document.getElementById('script-url').value = savedUrl;
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start-date').value = today;
            document.getElementById('end-date').value = today;
            renderTableRows(); 
        };

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msg = document.getElementById('toast-message');
            msg.innerText = message;
            toast.className = "fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-4 rounded-lg shadow-2xl text-white font-bold transition-all duration-300 z-[100] no-print flex items-center gap-3 min-w-[300px] justify-center";
            if (type === 'success') { toast.classList.add('bg-green-600'); icon.className = "fas fa-check-circle"; } 
            else { toast.classList.add('bg-red-600'); icon.className = "fas fa-exclamation-triangle"; }
            toast.classList.remove('hidden');
            setTimeout(() => { toast.classList.add('hidden'); }, 4000);
        }

        function switchTab(tab) {
            const newBtn = document.getElementById('tab-new');
            const searchBtn = document.getElementById('tab-search');
            const newView = document.getElementById('view-new-bill');
            const searchView = document.getElementById('view-search');
            if(tab === 'new') {
                newView.classList.remove('hidden'); searchView.classList.add('hidden');
                newBtn.classList.add('bg-blue-600', 'text-white'); newBtn.classList.remove('bg-white', 'text-gray-600');
                searchBtn.classList.remove('bg-blue-600', 'text-white'); searchBtn.classList.add('bg-white', 'text-gray-600');
            } else {
                newView.classList.add('hidden'); searchView.classList.remove('hidden');
                searchBtn.classList.add('bg-blue-600', 'text-white'); searchBtn.classList.remove('bg-white', 'text-gray-600');
                newBtn.classList.remove('bg-blue-600', 'text-white'); newBtn.classList.add('bg-white', 'text-gray-600');
            }
        }

        async function performSearch() {
            const query = document.getElementById('search-query').value;
            const scriptUrl = localStorage.getItem('scriptUrl');
            const resultDiv = document.getElementById('search-results');
            const btn = document.getElementById('btn-search');
            if(!scriptUrl) { alert("Please set URL in settings"); return; }
            if(!query) { alert("Enter text to search"); return; }
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; resultDiv.innerHTML = '';
            try {
                const response = await fetch(`${scriptUrl}?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                if(data.length === 0) { resultDiv.innerHTML = '<div class="text-center text-gray-500">No results found</div>'; } 
                else {
                    data.forEach(bill => {
                        const isPaid = bill.status === 'Paid';
                        const statusColor = isPaid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        const displayDate = new Date(bill.date).toLocaleString('en-GB');
                        const html = `<div class="bg-white p-5 rounded-lg shadow border-l-4 ${isPaid ? 'border-green-500' : 'border-red-500'}"><div class="flex justify-between items-start"><div><h3 class="font-bold text-lg">${bill.name}</h3><p class="text-gray-600 text-sm"><i class="fas fa-phone mr-1"></i> ${bill.phone}</p><p class="text-gray-500 text-xs mt-1">${displayDate}</p></div><div class="text-right"><div class="text-xl font-bold">₹ ${bill.total}</div><span class="inline-block px-2 py-1 rounded text-xs font-bold ${statusColor} mt-1">${bill.status}</span></div></div><div class="mt-3 text-sm text-gray-500 bg-gray-50 p-2 rounded">${bill.details || 'No details'}</div>${!isPaid ? `<button onclick="markAsPaid(this, ${bill.rowIndex})" class="mt-3 w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700"><i class="fas fa-check-circle mr-2"></i> Mark as Paid</button>` : ''}</div>`;
                        resultDiv.insertAdjacentHTML('beforeend', html);
                    });
                }
            } catch(e) { console.error(e); alert("Search failed."); }
            btn.innerHTML = 'Search';
        }

        async function markAsPaid(btn, rowIndex) {
            if(!confirm("Are you sure?")) return;
            const scriptUrl = localStorage.getItem('scriptUrl');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Updating...';
            try {
                await fetch(scriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'mark_paid', row: rowIndex }) });
                btn.parentElement.classList.remove('border-red-500'); btn.parentElement.classList.add('border-green-500');
                btn.parentElement.querySelector('.bg-red-100').className = 'inline-block px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-800 mt-1';
                btn.parentElement.querySelector('.bg-green-100').innerText = 'Paid'; btn.remove();
                showToast("Marked as Paid!", "success");
            } catch(e) { showToast("Error updating status.", "error"); btn.innerHTML = originalText; }
        }

        function calcDays() {
            const startStr = document.getElementById('start-date').value;
            const endStr = document.getElementById('end-date').value;
            if(startStr && endStr) {
                const diffTime = new Date(endStr) - new Date(startStr);
                let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                if (diffDays < 1) diffDays = 1;
                document.getElementById('total-days').innerText = diffDays;
                document.getElementById('days-display').innerText = diffDays;
                recalcAll();
            }
        }
        function recalcAll() {
            const l = parseFloat(document.getElementById('mandap-l').value) || 0;
            const w = parseFloat(document.getElementById('mandap-w').value) || 0;
            let mandapDaily = 0;
            if ((l*w) > 0) mandapDaily = Math.round(((l*w) / STANDARD_AREA) * STANDARD_RATE);
            document.getElementById('mandap-details').innerText = `Size: ${l}x${w} (${l*w} sq.ft)`;
            document.getElementById('mandap-price').innerText = mandapDaily;
            const itemsDaily = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const days = parseInt(document.getElementById('total-days').innerText) || 1;
            const dailyTotal = mandapDaily + itemsDaily;
            const subtotal = dailyTotal * days;
            document.getElementById('daily-total').innerText = dailyTotal;
            document.getElementById('subtotal').innerText = subtotal;
            const cgstRate = 9; const sgstRate = 9;
            const cgstAmt = Math.round((subtotal * cgstRate) / 100);
            const sgstAmt = Math.round((subtotal * sgstRate) / 100);
            document.getElementById('cgst-amt').innerText = cgstAmt;
            document.getElementById('sgst-amt').innerText = sgstAmt;
            document.getElementById('cgst-print-rate').innerText = cgstRate;
            document.getElementById('sgst-print-rate').innerText = sgstRate;
            document.getElementById('final-total').innerText = subtotal + cgstAmt + sgstAmt;
        }
        function renderTableRows() {
            const tbody = document.getElementById('items-list');
            tbody.innerHTML = '';
            items.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-50 hover:bg-gray-50 group';
                tr.innerHTML = `<td class="py-3 font-medium text-gray-700 text-sm">${item.name}</td><td class="py-3 text-center"><input type="number" oninput="handleInput(${index}, 'price', this.value)" value="${item.price}" class="w-16 text-center bg-transparent border-b border-gray-200 focus:border-blue-500 outline-none p-1 text-base"></td><td class="py-3 text-center"><input type="number" oninput="handleInput(${index}, 'qty', this.value)" value="${item.qty}" class="w-16 text-center bg-gray-100 rounded p-1 focus:bg-white focus:ring-2 ring-blue-500 outline-none p-1 text-base"></td><td class="py-3 text-right font-medium text-gray-800 text-sm">₹ <span id="row-total-${index}">${item.price * item.qty}</span></td><td class="no-print text-center"><button onclick="deleteItem(${index})" class="text-red-300 hover:text-red-500 p-2"><i class="fas fa-trash"></i></button></td>`;
                tbody.appendChild(tr);
            });
            recalcAll();
        }
        function handleInput(index, field, value) { items[index][field] = parseFloat(value) || 0; document.getElementById(`row-total-${index}`).innerText = items[index].price * items[index].qty; recalcAll(); }
        function addNewItem() {
            const name = document.getElementById('new-item-name').value;
            const price = document.getElementById('new-item-price').value;
            if (name && price) { items.push({ id: Date.now(), name, price: parseFloat(price), qty: 0 }); renderTableRows(); }
        }
        function deleteItem(index) { if(confirm('Remove?')) { items.splice(index, 1); renderTableRows(); } }
        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); document.getElementById('settings-modal').classList.toggle('flex'); }
        function saveSettings() { localStorage.setItem('scriptUrl', document.getElementById('script-url').value); toggleSettings(); alert("Saved!"); }
        
        async function printAndSave() {
            const custName = document.getElementById('cust-name').value;
            if (!custName) { showToast("Please enter Customer Name!", "error"); return; }
            const btn = document.getElementById('btn-print');
            const originalText = btn.innerHTML;
            const scriptUrl = localStorage.getItem('scriptUrl');
            let printTriggered = false;
            const triggerPrint = () => {
                if(!printTriggered) { printTriggered = true; btn.innerHTML = originalText; window.print(); }
            };
            document.getElementById('current-date').innerText = new Date().toLocaleString('en-GB');
            if (scriptUrl) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';
                setTimeout(triggerPrint, 1500); 
                const mandapDetails = parseFloat(document.getElementById('mandap-price').innerText) > 0 ? `Mandap: ${document.getElementById('mandap-l').value}x${document.getElementById('mandap-w').value}` : '';
                const itemDetails = items.filter(i => i.qty > 0).map(i => `${i.name} x${i.qty}`).join(', ');
                const payload = {
                    action: 'create', name: custName, phone: document.getElementById('cust-phone').value,
                    startDate: document.getElementById('start-date').value, endDate: document.getElementById('end-date').value,
                    days: document.getElementById('total-days').innerText, details: [mandapDetails, itemDetails].filter(Boolean).join(' | '),
                    subtotal: document.getElementById('subtotal').innerText, cgst: document.getElementById('cgst-amt').innerText,
                    sgst: document.getElementById('sgst-amt').innerText, total: document.getElementById('final-total').innerText
                };
                try { 
                    await fetch(scriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); 
                    showToast("Bill Saved Successfully!", "success"); triggerPrint();
                } catch (error) { console.error(error); showToast("Network Error!", "error"); triggerPrint(); }
            } else { showToast("No Script URL!", "error"); triggerPrint(); }
        }
    </script>
</body>
</html>
