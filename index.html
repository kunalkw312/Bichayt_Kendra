<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bichayt Kendra Manager</title>
    
    <meta name="theme-color" content="#4f46e5">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Poppins', 'sans-serif'],
                        marathi: ['Noto Sans Devanagari', 'sans-serif']
                    },
                    colors: { primary: '#4f46e5', primaryDark: '#4338ca', secondary: '#10b981' },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out', 'slide-up': 'slideUp 0.4s ease-out', 'pop-in': 'popIn 0.2s ease-out' },
                    keyframes: { 
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }, 
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        popIn: { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .custom-scroll::-webkit-scrollbar { height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* === PRINT STYLES === */
        @media print {
            @page { size: A4; margin: 5mm; }
            
            /* RESET */
            html, body { 
                height: auto !important; 
                min-height: 0 !important; 
                overflow: visible !important; 
                margin: 0 !important; 
                padding: 0 !important; 
                background: white !important; 
                font-family: 'Noto Sans Devanagari', sans-serif !important; 
                color: black !important; 
                display: block !important; 
            }
            
            /* Hide Screen Elements */
            .no-print, #tab-nav, #settings-modal, #payment-modal, #custom-mandap-modal, #toast, #btn-install, .fab-button, .gst-toggle-container, .payment-input-area, .add-mandap-btn, #new-item-row, .mandap-input-group, #history-tabs, #edit-mode-bar, .bg-gradient-to-r, .edit-btn-print, .row-actions { display: none !important; }
            
            /* Container Reset */
            #main-container { box-shadow: none !important; border: none !important; margin: 0 !important; width: 100% !important; max-width: 100% !important; padding: 0 !important; background: transparent !important; border-radius: 0 !important; }
            #view-new-bill { padding-bottom: 0 !important; display: block !important; }
            
            /* --- HEADER LAYOUT --- */
            .print-header-marathi { display: block !important; margin-bottom: 0px; padding-top: 10px; }
            
            .title-main { 
                font-size: 26pt; 
                font-weight: 900; 
                text-align: center; 
                line-height: 1; 
                margin-bottom: 5px; 
                color: #FF4B33 !important; 
            }
            
            /* Header Grid */
            .header-grid {
                display: grid;
                grid-template-columns: 20% 60% 20%; 
                font-size: 10pt;
                font-weight: 700;
                color: #FF4B33 !important;
                line-height: 1.3;
            }
            
            .h-center { text-align: center; }
            .h-right { text-align: right; white-space: nowrap; }
            
            /* Meta Box */
            .meta-box { border-top: 1.5pt solid #FF4B33 !important; border-bottom: 1.5pt solid #FF4B33 !important; display: flex; justify-content: space-between; align-items: center; padding: 2px 5mm; font-weight: 700; font-size: 10pt; margin-bottom: 5px; color: #FF4B33 !important; margin-top: 5px; }
            .doc-type-label { text-align: center; font-weight: 800; font-size: 11pt; border: 1.5pt solid #FF4B33 !important; padding: 0px 10px; border-radius: 4px; display: inline-block; background: white; color: #FF4B33 !important; }

            /* Content - Force Black */
            .print-table-container, .print-table-container * { color: black !important; }
            .print-table-container { padding: 0 5mm; }
            
            /* FORCE 2 COLUMNS ON MOBILE PRINT */
            .print-grid { 
                display: grid !important; 
                grid-template-columns: 1fr 1fr !important; 
                gap: 10px !important; 
                margin-bottom: 10px !important; 
                padding: 0 5mm !important; 
            }

            .bg-blue-50, .bg-yellow-50, .bg-white, .shadow-lg, .rounded-2xl, .rounded-xl { background: none !important; box-shadow: none !important; border: none !important; padding: 0 !important; margin: 0 !important; }
            .border-b-2 { border-bottom: 0.5pt solid #ccc !important; }
            
            /* Separator Line */
            .print-separator { 
                border-top: 1px solid black !important; 
                margin: 5px 0 8px 0 !important; 
                width: 100%; 
                height: 1px;
                display: none; 
            }
            .print-separator.visible { display: block !important; }

            /* Inputs */
            input, select { 
                border: none !important; 
                background: transparent !important; 
                padding: 0 !important; 
                height: auto !important; 
                width: 100% !important; 
                font-weight: 600; 
                font-size: 10pt; 
                color: black !important; 
                margin: 0 !important; 
                box-shadow: none !important;
            }
            input::-webkit-calendar-picker-indicator { display: none !important; }
            
            /* Hide the actual inputs for Name/Phone in print, show spans instead */
            .input-hide-print { display: none !important; }
            
            /* Customer Name/Phone Display Spans - NO BORDER/UNDERLINE */
            #p-cust-name-display, #p-cust-phone-display {
                border: none !important;
                border-bottom: none !important;
                text-decoration: none !important;
            }

            /* Mandap specific */
            .mandap-select-print { display: none !important; }
            .mandap-text-print { display: inline-block !important; font-weight: 700; color: black !important; }
            .mandap-row-container { background: transparent !important; border: none !important; padding: 0 !important; margin-bottom: 2px !important; border-radius: 0 !important; }
            
            /* FORCE COLORS TO BLACK FOR DATA */
            .mandap-label-print { color: black !important; }
            .mandap-amount-print { color: black !important; }
            .mandap-amount-box { color: black !important; background: transparent !important; }
            
            /* Tables */
            table { width: 100% !important; border-collapse: collapse; margin-top: 2px; }
            tr { break-inside: avoid; page-break-inside: avoid; }
            th { border-top: 1pt solid black; border-bottom: 1pt solid black; text-align: center; padding: 2px; font-size: 10pt; font-weight: 800; color: black !important; }
            td { border-bottom: 0.5pt solid #ddd; padding: 2px; font-size: 10pt; text-align: center; color: black !important; }
            td:first-child, th:first-child { text-align: left; }
            td:last-child, th:last-child { text-align: right; }

            /* Totals */
            .totals-section { float: right; width: 50%; margin-top: 5px; padding-right: 5mm; color: black !important; page-break-inside: avoid; break-inside: avoid; }
            .totals-final { 
                font-size: 12pt !important; 
                font-weight: 800 !important; 
                margin-top: 5px !important; 
                border-top: 1pt solid black !important; 
                border-bottom: none !important;
                border-left: none !important;
                border-right: none !important;
                padding-top: 5px !important; 
                color: black !important; 
                background: transparent !important;
                border-radius: 0 !important;
                box-shadow: none !important;
            }
            .totals-final span { color: black !important; }
            .text-primary { color: black !important; } 
            
            /* Footer Note */
            .print-footer { position: relative; width: 100%; text-align: left; font-size: 9pt; padding-bottom: 0; margin-top: 15px; color: black !important; clear: both; display: block !important; }
            .footer-note-text { color: #FF4B33 !important; font-weight: 700; font-size: 9pt; white-space: pre-wrap; }
            
            /* Utility */
            .screen-only { display: none !important; }
            .print-only { display: inline-block !important; color: black !important; font-weight: 700; } 
            
            .show-print { display: block !important; } 
            .hide-print { display: none !important; }
            .quotation-mode .hide-on-quotation { display: none !important; }
            .invoice-mode .hide-on-invoice { display: none !important; }
            .hidden { display: none !important; }
        }
        .show-print, .print-header-marathi, .mandap-text-print, .print-separator { display: none; }
        .screen-only { display: block; }
        .print-only { display: none; }
        
        .tab-btn-active { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        .tab-btn-inactive { background-color: white; color: #6b7280; border-color: #e5e7eb; }

        /* SUGGESTION LIST STYLE */
        #suggestion-list {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.875rem;
            color: #374151;
        }
        .suggestion-item:hover {
            background-color: #f3f4f6;
            color: #4f46e5;
        }
    </style>
</head>
<body class="text-gray-700 font-sans">

    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 z-50 hidden transition-all duration-300 min-w-[280px] justify-center">
        <i id="toast-icon" class="fas fa-info-circle text-lg"></i><span id="toast-message" class="font-medium">Notification</span>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4 transition-opacity duration-300 no-print">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-slide-up flex flex-col max-h-[90vh]">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-gray-800 text-lg">⚙️ App Settings</h3>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto custom-scroll">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Google Sheet URL</label>
                    <input type="text" id="script-url" class="w-full px-4 py-2 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all text-sm" placeholder="Paste Web App URL...">
                </div>
                <div class="pt-2 border-t border-gray-100">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Default Items & Prices</label>
                    <div id="settings-items-list" class="space-y-2 mb-3"></div>
                    <button onclick="addSettingsRow()" class="text-sm text-primary font-bold hover:text-primaryDark flex items-center gap-1"><i class="fas fa-plus-circle"></i> Add New Default Item</button>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
                <button onclick="toggleSettings()" class="px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-200 rounded-lg">Close</button>
                <button onclick="saveSettings()" id="btn-save-settings" class="px-6 py-2 text-sm font-bold text-white bg-primary hover:bg-primaryDark rounded-lg shadow-lg flex items-center gap-2">Save All</button>
            </div>
        </div>
    </div>

    <!-- CUSTOM MANDAP NAME MODAL -->
    <div id="custom-mandap-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4 transition-opacity duration-300 no-print">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-pop-in">
            <div class="p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-1 text-center">Custom Mandap Name</h3>
                <input type="text" id="custom-mandap-input" class="w-full p-3 border-2 border-primary/20 rounded-xl text-center font-bold text-gray-800 focus:border-primary outline-none transition-all mb-4" placeholder="e.g. Stage Decoration">
                <div class="flex gap-3">
                    <button onclick="closeCustomMandapModal()" class="flex-1 py-2.5 text-sm font-bold text-gray-500 bg-gray-50 hover:bg-gray-100 rounded-xl">Cancel</button>
                    <button onclick="confirmCustomMandapName()" class="flex-1 py-2.5 text-sm font-bold text-white bg-primary hover:bg-primaryDark rounded-xl shadow-lg">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div id="payment-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4 transition-opacity duration-300 no-print">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-pop-in">
            <div class="p-6 text-center">
                <h3 class="text-lg font-bold text-gray-900 mb-1">Add Partial Payment</h3>
                <div class="relative mb-6 mt-4">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">₹</span>
                    <input type="number" id="modal-payment-amount" class="w-full pl-8 pr-4 py-3 border-2 border-gray-100 rounded-xl text-lg font-bold text-gray-800 focus:border-green-500 outline-none transition-all" placeholder="0">
                </div>
                <div class="flex gap-3">
                    <button onclick="closePaymentModal()" class="flex-1 py-3 text-sm font-bold text-gray-500 bg-gray-50 hover:bg-gray-100 rounded-xl">Cancel</button>
                    <button id="btn-confirm-pay" onclick="submitPayment()" class="flex-1 py-3 text-sm font-bold text-white bg-green-500 hover:bg-green-600 rounded-xl shadow-lg">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="max-w-5xl mx-auto min-h-screen flex flex-col">
        
        <!-- HEADER -->
        <div class="px-4 py-5 flex justify-between items-center no-print">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-primary to-purple-600 rounded-xl flex items-center justify-center text-white shadow-lg"><i class="fas fa-campground"></i></div>
                <div><h1 class="text-lg font-bold text-gray-900 leading-tight">Bichayt Kendra</h1><p class="text-xs text-gray-500 font-medium">Management System</p></div>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleSettings()" class="w-10 h-10 bg-white text-gray-500 rounded-full shadow-sm border border-gray-100 flex items-center justify-center hover:text-primary hover:border-primary/30 transition-all"><i class="fas fa-cog"></i></button>
            </div>
        </div>

        <!-- TABS -->
        <div id="tab-nav" class="px-4 mb-6 no-print">
            <div class="bg-white p-1.5 rounded-xl shadow-sm border border-gray-100 flex gap-1">
                <button onclick="switchTab('new')" id="tab-new" class="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2 bg-primary text-white shadow-md"><i class="fas fa-file-invoice"></i> New Bill</button>
                <button onclick="switchTab('calc')" id="tab-calc" class="flex-1 py-2.5 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 transition-all duration-300 flex items-center justify-center gap-2"><i class="fas fa-calculator"></i> Pipe Calc</button>
                <button onclick="switchTab('search')" id="tab-search" class="flex-1 py-2.5 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 transition-all duration-300 flex items-center justify-center gap-2"><i class="fas fa-search"></i> Search History</button>
            </div>
        </div>

        <!-- === VIEW: NEW BILL === -->
        <div id="view-new-bill" class="flex-grow flex flex-col px-4 pb-24 animate-fade-in">
            <div id="main-container" class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden relative">
                
                <!-- VISUAL HEADER (Screen) -->
                <div class="bg-gradient-to-r from-primary to-purple-700 p-6 text-white no-print screen-header-gradient">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-2xl font-bold tracking-tight">Invoice</h2>
                            <p class="text-white/80 text-sm mt-0.5">Bichayt Kendra & Events</p>
                        </div>
                        <div class="text-right bg-white/10 px-3 py-1 rounded-lg backdrop-blur-sm border border-white/20">
                            <div class="text-xs text-white/70 uppercase font-bold tracking-wider">Date</div>
                            <div class="text-sm font-mono font-bold" id="current-date">...</div>
                        </div>
                    </div>
                    <div id="edit-mode-bar" class="hidden mt-4 bg-yellow-400/20 border border-yellow-400/50 rounded-lg p-2 flex justify-between items-center">
                        <span class="text-xs font-bold text-yellow-200 flex items-center gap-2"><i class="fas fa-edit"></i> Editing Old Bill</span>
                        <button onclick="exitEditMode()" class="text-xs bg-white text-yellow-700 px-2 py-1 rounded font-bold hover:bg-yellow-50">Cancel</button>
                    </div>
                </div>

                <!-- NEW PRINT HEADER (MARATHI) -->
                <div class="print-header-marathi" id="print-header-section">
                    <div class="title-main">भुंबर बिछायत व डेकोरेशन ॲण्ड कॅटरर्स</div>
                    
                    <!-- 3-ROW HEADER GRID -->
                    <div class="header-grid">
                        <!-- Row 1 -->
                        <div></div>
                        <div></div>
                        <div class="h-right">प्रो.प्रा.सौरभ भुंबर</div>

                        <!-- Row 2 -->
                        <div></div>
                        <div class="h-center">सर्व प्रकारचे डेकोरेशन तसेच ईव्हेन्ट मॅनेजमेन्टचे कामे केल्या जातील</div>
                        <div class="h-right">9823528733</div>

                        <!-- Row 3 -->
                        <div></div>
                        <div class="h-center">गाडगे बाबा मार्केट, गाडगे नगर, अमरावती</div>
                        <div class="h-right hide-on-quotation">GSTN NO 27BIWPB4912MIZS</div>
                    </div>
                    
                    <div class="meta-box">
                        <div class="w-1/3 text-left">जा.क्र.: <span id="print-id-text-marathi">...</span></div>
                        <div class="w-1/3 text-center"><div class="doc-type-label" id="print-doc-type">इन्व्हॉइस</div></div>
                        <!-- Blank Date for Manual Entry -->
                        <div class="w-1/3 text-right">दिनांक: <span id="print-date-marathi">________________</span></div>
                    </div>
                </div>

                <div class="p-4 md:p-6 print-table-container">
                    <!-- Customer & Dates -->
                    <div class="print-grid grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="space-y-4 print-col">
                            <div class="relative group">
                                <label class="absolute -top-2.5 left-3 bg-white px-1 text-xs font-bold text-primary group-focus-within:text-primary transition-colors screen-only">Customer Name</label>
                                <!-- Print Only Label -->
                                <span class="print-only font-bold text-sm whitespace-nowrap mr-2">Customer Name: </span>
                                <!-- Using Span for Print Value to ensure visibility -->
                                <span id="p-cust-name-display" class="print-only font-bold text-sm min-w-[150px] inline-block"></span>
                                <input type="text" id="cust-name" class="w-full p-3 border border-gray-200 rounded-xl outline-none focus:border-primary font-medium text-sm input-hide-print">
                            </div>
                            <div class="relative group">
                                <label class="absolute -top-2.5 left-3 bg-white px-1 text-xs font-bold text-gray-500 group-focus-within:text-primary transition-colors screen-only">Phone Number</label>
                                <!-- Print Only Label -->
                                <span class="print-only font-bold text-sm whitespace-nowrap mr-2">Contact Number: </span>
                                <!-- Using Span for Print Value -->
                                <span id="p-cust-phone-display" class="print-only font-bold text-sm min-w-[150px] inline-block"></span>
                                <input type="number" id="cust-phone" class="w-full p-3 border border-gray-200 rounded-xl outline-none focus:border-primary font-medium text-sm input-hide-print">
                            </div>
                        </div>
                        <div class="print-col bg-yellow-50/50 p-4 rounded-xl border border-yellow-100 hide-print">
                            <div class="flex justify-between items-center mb-3"><label class="text-xs font-bold text-yellow-700 uppercase tracking-wider">Function Dates</label><span class="bg-yellow-100 text-yellow-800 text-[10px] font-bold px-2 py-0.5 rounded-full">Global</span></div>
                            <div class="flex gap-2">
                                <div class="flex-1"><span class="text-[10px] text-gray-400 block mb-1 font-bold pl-1">START</span><input type="date" id="start-date" onchange="calcDays()" class="w-full p-1.5 bg-white border border-gray-200 rounded-lg text-xs font-medium focus:border-yellow-400 outline-none"></div>
                                <div class="flex-1"><span class="text-[10px] text-gray-400 block mb-1 font-bold pl-1">END</span><input type="date" id="end-date" onchange="calcDays()" class="w-full p-1.5 bg-white border border-gray-200 rounded-lg text-xs font-medium focus:border-yellow-400 outline-none"></div>
                            </div>
                            <div class="mt-3 flex justify-end"><div class="text-xs font-bold text-gray-700 bg-white px-3 py-1 rounded-lg border border-gray-100 shadow-sm">Total: <span class="text-yellow-600 text-base" id="total-days">1</span> Days</div></div>
                        </div>
                        <div class="show-print print-col" style="text-align: right;">
                            <div style="margin-bottom: 2px;"><strong>From:</strong> <span id="print-start-date"></span></div>
                            <div style="margin-bottom: 2px;"><strong>To:</strong> <span id="print-end-date"></span></div>
                            <div style="font-size: 11pt;"><strong>Duration:</strong> <span id="print-total-days">1</span> Days</div>
                        </div>
                    </div>
                    
                    <!-- Line Separator (Visible only if Mandaps exist) -->
                    <div id="print-mandap-separator" class="print-separator hidden"></div>

                    <!-- Mandap Section -->
                    <div class="mb-6">
                        <div class="flex justify-between items-end mb-2 no-print">
                            <h3 class="font-bold text-gray-800 text-base">Mandaps</h3>
                            <button onclick="addMandapRow()" class="add-mandap-btn text-[10px] bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-full font-bold transition-colors"><i class="fas fa-plus mr-1"></i> Add Mandap</button>
                        </div>
                        <div id="mandap-list-container" class="space-y-3"></div>
                    </div>

                    <!-- Items -->
                    <div class="mb-6">
                        <div class="flex justify-between items-end mb-2 no-print"><h3 class="font-bold text-gray-800 text-base">Items</h3><span class="text-[10px] text-gray-400">Scroll ></span></div>
                        <div class="overflow-x-auto custom-scroll pb-2 border border-gray-100 rounded-xl">
                            <table class="w-full min-w-full">
                                <thead class="bg-gray-50 border-b border-gray-100">
                                    <tr class="text-[10px] md:text-xs font-bold text-gray-400 uppercase text-left">
                                        <th class="p-2 pl-3 w-[40%]">Item</th>
                                        <!-- Swapped Qty and Rate Headers -->
                                        <th class="p-2 text-center w-[10%]">Qty</th>
                                        <th class="p-2 text-center w-[15%]">Rate</th>
                                        <th class="p-2 text-center w-[10%] bg-yellow-50/50 text-yellow-600">Days</th>
                                        <th class="p-2 text-right pr-3 w-[20%]">Total</th>
                                        <th class="p-2 w-[5%] no-print"></th>
                                    </tr>
                                </thead>
                                <tbody id="items-list" class="divide-y divide-gray-50 text-xs md:text-sm"></tbody>
                            </table>
                        </div>
                        <!-- ADD NEW ITEM ROW WITH SUGGESTION SUPPORT -->
                        <div class="mt-2 flex gap-2 no-print p-2 bg-gray-50 rounded-xl border border-dashed border-gray-300 relative" id="new-item-row">
                            <div class="relative flex-1 min-w-0">
                                <input type="text" id="new-item-name" placeholder="Item Name" autocomplete="off" class="w-full bg-white border-none rounded-lg shadow-sm px-3 py-2 text-xs focus:ring-2 focus:ring-primary/20">
                                <!-- SUGGESTION LIST CONTAINER -->
                                <div id="suggestion-list" class="hidden"></div>
                            </div>
                            <!-- CHANGED TO TEXT TYPE AS REQUESTED -->
                            <input type="text" id="new-item-price" placeholder="Rate" class="w-16 bg-white border-none rounded-lg shadow-sm px-2 py-2 text-xs text-center focus:ring-2 focus:ring-primary/20">
                            <button onclick="addNewItem()" class="bg-primary hover:bg-primaryDark text-white w-10 h-10 flex-none shrink-0 rounded-lg shadow-lg flex items-center justify-center transition-transform active:scale-95">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Totals -->
                    <div class="totals-section">
                        <div class="w-full md:w-2/3 ml-auto">
                            <div class="flex justify-between items-center mb-2 pb-2 border-b border-gray-100"><span class="text-gray-500 font-medium text-xs">Subtotal</span><span class="text-base font-bold text-gray-800">₹ <span id="subtotal">0</span></span></div>
                            <div class="no-print gst-toggle-container mb-2 flex justify-end"><label class="inline-flex items-center cursor-pointer"><input type="checkbox" id="gst-toggle" class="sr-only peer" onchange="recalcGrandTotalsOnly()"><div class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary"></div><span class="ms-2 text-xs font-medium text-gray-900">GST (18%)</span></label></div>
                            <div id="tax-rows" class="space-y-1 mb-2 hidden"><div class="flex justify-between text-xs text-gray-500"><span>CGST (9%)</span><span>+ ₹ <span id="cgst-amt">0</span></span></div><div class="flex justify-between text-xs text-gray-500"><span>SGST (9%)</span><span>+ ₹ <span id="sgst-amt">0</span></span></div></div>
                            <div class="bg-primary/5 rounded-xl p-3 flex justify-between items-center border border-primary/10 totals-final"><span class="text-primary font-bold uppercase tracking-wider text-xs">Grand Total</span><span class="text-xl font-bold text-primary">₹ <span id="final-total">0</span></span></div>
                            <div class="payment-input-area mt-4 border-t border-dashed border-gray-300 pt-3 no-print"><div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-gray-500 uppercase">Advance / Paid</span><input type="number" id="paid-amount" placeholder="0" oninput="recalcTotals()" class="w-24 text-right border-b-2 border-gray-200 focus:border-green-500 bg-transparent outline-none font-bold text-green-600"></div><div class="flex justify-between items-center"><span class="text-xs font-bold text-red-400 uppercase">Balance Due</span><span class="text-lg font-bold text-red-500">₹ <span id="balance-due">0</span></span></div></div>
                            <div class="print-balance show-print hide-on-quotation"><div class="flex justify-between w-full text-sm"><span>Paid Amount:</span><span>₹ <span id="print-paid">0</span></span></div><div class="flex justify-between w-full text-sm mt-1 border-t border-black pt-1"><span>Balance Due:</span><span>₹ <span id="print-balance">0</span></span></div></div>
                        </div>
                    </div>

                    <div class="mt-6 no-print">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Footer Note (Print Only)</label>
                        <input type="text" id="footer-text-input" placeholder="e.g. Terms & Conditions apply..." class="w-full p-2 border border-gray-200 rounded-lg text-sm focus:border-primary outline-none">
                    </div>

                    <div class="print-footer show-print">
                        <div id="print-footer-custom" class="footer-note-text"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- === VIEW: PIPE CALCULATOR === -->
        <div id="view-pipe-calc" class="flex-grow hidden px-4 pb-24 animate-fade-in w-full max-w-xl mx-auto">
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                <div class="text-center mb-6"><div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-3 text-orange-600 text-xl"><i class="fas fa-calculator"></i></div><h2 class="text-xl font-bold text-gray-800">Pipe & Ceiling Calc</h2></div>
                <div class="grid grid-cols-2 gap-4 mb-8"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-2">Length (ft)</label><input type="number" id="calc-l" class="w-full p-3 border-2 border-gray-100 rounded-xl text-center text-lg font-bold focus:border-orange-400 outline-none" placeholder="0" step="15" min="0" onchange="snapToGrid(this)" oninput="calcDedicatedPipes()"></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-2">Width (ft)</label><input type="number" id="calc-w" class="w-full p-3 border-2 border-gray-100 rounded-xl text-center text-lg font-bold focus:border-orange-400 outline-none" placeholder="0" step="15" min="0" onchange="snapToGrid(this)" oninput="calcDedicatedPipes()"></div></div>
                <div class="space-y-4">
                    <div class="bg-orange-50 p-4 rounded-xl border border-orange-100 flex justify-between items-center"><div><h3 class="font-bold text-orange-800">Vertical Pipes</h3></div><div class="text-2xl font-bold text-orange-600" id="res-v">0</div></div>
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex justify-between items-center"><div><h3 class="font-bold text-blue-800">Horizontal Pipes</h3></div><div class="text-2xl font-bold text-blue-600" id="res-h">0</div></div>
                    <div class="bg-purple-50 p-4 rounded-xl border border-purple-100 flex justify-between items-center"><div><h3 class="font-bold text-purple-800">Ceiling Cloths</h3></div><div class="text-2xl font-bold text-purple-600" id="res-c">0</div></div>
                </div>
            </div>
        </div>

        <!-- === VIEW: SEARCH === -->
        <div id="view-search" class="flex-grow hidden px-4 pb-24 animate-fade-in w-full max-w-4xl mx-auto">
            <div class="bg-white p-2 rounded-2xl shadow-lg mb-6 sticky top-4 z-20 border border-gray-100">
                <div class="flex justify-center mb-4 gap-2 no-print" id="history-tabs">
                    <button onclick="setHistoryFilter('BILL')" id="btn-hist-bills" class="flex-1 py-2 rounded-lg text-sm font-bold border transition-all tab-btn-active">Bills</button>
                    <button onclick="setHistoryFilter('QUOTATION')" id="btn-hist-quotes" class="flex-1 py-2 rounded-lg text-sm font-bold border transition-all tab-btn-inactive">Quotations</button>
                </div>
                <div class="flex gap-2">
                    <div class="relative flex-1">
                        <i class="fas fa-search absolute left-4 top-3.5 text-gray-400"></i>
                        <input type="text" id="search-query" class="w-full pl-12 pr-4 py-3 bg-gray-50 rounded-xl outline-none focus:bg-white focus:ring-2 focus:ring-primary/20 transition-all font-medium text-gray-700 text-sm" placeholder="Name or Phone...">
                    </div>
                    <input type="date" id="search-date" class="w-1/3 px-3 py-3 bg-gray-50 rounded-xl outline-none focus:bg-white focus:ring-2 focus:ring-primary/20 text-sm font-medium text-gray-600">
                </div>
                <button onclick="performSearch()" id="btn-search" class="w-full bg-primary text-white py-3 rounded-xl font-bold shadow-md hover:bg-primaryDark transition-colors text-sm flex items-center justify-center gap-2 mt-2">
                    <i class="fas fa-filter"></i> Search Records
                </button>
            </div>
            <div id="search-results" class="space-y-4"><div class="flex flex-col items-center justify-center text-gray-300 mt-20"><i class="fas fa-receipt text-6xl mb-4 opacity-50"></i><p class="text-lg font-medium">Search for old bills</p></div></div>
        </div>
    </div>

    <!-- FAB ACTIONS -->
    <div class="fixed bottom-6 left-4 right-4 z-40 flex gap-3 no-print" id="fab-container">
        <button onclick="saveAndPrintBill('QUOTATION')" class="flex-1 bg-gray-800 text-white py-4 rounded-2xl shadow-xl font-bold text-sm flex items-center justify-center gap-2 transform transition-all hover:scale-[1.02] active:scale-95 border border-gray-700">
            <i class="fas fa-file-alt text-yellow-400"></i> Quotation
        </button>
        <button onclick="saveAndPrintBill('BILL')" id="btn-save-print" class="flex-1 bg-primary text-white py-4 rounded-2xl shadow-xl font-bold text-sm flex items-center justify-center gap-2 transform transition-all hover:scale-[1.02] active:scale-95 border border-primaryDark">
            <i class="fas fa-save"></i> Save & Print
        </button>
    </div>

    <script>
        const DEFAULT_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzObEvXSCD2mF7QPCUGtIdcTZUlynPlcRAdbCW0Jkj09Qbv_bFZeus1FTtzL5UIli1YJg/exec"; 
        const DEFAULT_GSTIN = "24585435642";
        
        let globalDefaults = []; 
        let items = [];
        let mandaps = []; 
        const MANDAP_TYPES = { 'Normal': 15, 'Waterproof': 25, 'Dripping': 30 };
        let editingRowIndex = null;
        let currentPaymentRow = null;
        let activeTab = 'new';
        let touchStartX = 0, touchEndX = 0, touchStartY = 0, touchEndY = 0;
        let pendingCustomIndex = null;
        let currentHistoryFilter = 'BILL';
        let allFetchedData = [];

        // --- ITEM CATALOG FOR AUTO-SUGGESTION ---
        const ITEM_CATALOG = [
            { en: "khurchi", mr: "खुर्ची" }, { en: "chair", mr: "खुर्ची" },
            { en: "ganj", mr: "गंज (छोटा मिडीयम मोठा)" },
            { en: "zhakani", mr: "झाकणी (छोटा मिडीयम मोठा)" }, { en: "jakani", mr: "झाकणी (छोटा मिडीयम मोठा)" },
            { en: "khomcha", mr: "खॉमचा" },
            { en: "poli bhatta", mr: "पोळी भट्टा" },
            { en: "pak kadhai", mr: "पाक कढई (छोटा मिडीयम मोठा)" },
            { en: "tel kadhai", mr: "तेल कढई (छोटा मिडीयम मोठा)" },
            { en: "bhatti", mr: "भट्टी (सिंगल डबल)" },
            { en: "sarata", mr: "सराटा (छोटा मिडीयम मोठा)" },
            { en: "poli path", mr: "पोळी पाठ" }, { en: "path", mr: "पाठ" },
            { en: "pavshi", mr: "पावशी" },
            { en: "drum", mr: "ड्रम" },
            { en: "dandiganj", mr: "दांडिगंज" },
            { en: "bucket", mr: "बकेट" },
            { en: "dhame", mr: "धामे" },
            { en: "chamche", mr: "चमचे" }, { en: "spoon", mr: "चमचे" },
            { en: "bhat vadhani", mr: "भात वाढणी" },
            { en: "plate", mr: "प्लेट" },
            { en: "vati", mr: "वाटी" }, { en: "bowl", mr: "वाटी" },
            { en: "carat", mr: "कॅरेट" },
            { en: "table", mr: "टेबल" },
            { en: "steel tub", mr: "स्टील टब" },
            { en: "gadi", mr: "गादी" }, { en: "mattress", mr: "गादी" },
            { en: "chadar", mr: "चादर" }, { en: "bedsheet", mr: "चादर" },
            { en: "blanket", mr: "ब्लॅंकेट" },
            { en: "ushi", mr: "उशी" }, { en: "pillow", mr: "उशी" },
            { en: "ushi cover", mr: "उशी कावर" }, { en: "pillow cover", mr: "उशी कावर" },
            { en: "load", mr: "लोड" }, { en: "load cover", mr: "लोड कव्हर" },
            { en: "sag patra", mr: "साग पात्र" },
            { en: "spirit lamp", mr: "स्पिरिट लॅम्प" }, { en: "spirit lamp sadha", mr: "स्पिरिट लॅम्प साधा" },
            { en: "chaku", mr: "चाकू" }, { en: "knife", mr: "चाकू" },
            { en: "chilani", mr: "चिलनी" },
            { en: "vagralu", mr: "वगराळू" },
            { en: "pohe chamcha", mr: "पोहे चम्मच" },
            { en: "steel tat", mr: "स्टील ताट" }, { en: "steel plate", mr: "स्टील प्लेट" },
            { en: "steel vati", mr: "स्टील वाटी" },
            { en: "dustbin", mr: "डस्टबिन" },
            { en: "besing", mr: "बेसिंग" },
            { en: "jalebi kadhai", mr: "जलेबी कढई" },
            { en: "chimta", mr: "चिमटा" },
            { en: "jug", mr: "जग" },
            { en: "steel glass", mr: "स्टील ग्लास" }, { en: "plastic glass", mr: "प्लास्टिक ग्लास" },
            { en: "kopar", mr: "कोपर" },
            { en: "satranji", mr: "सतरंगी" }, { en: "carpet", mr: "सतरंगी" },
            { en: "green mat", mr: "ग्रीन मेटिंग" },
            { en: "belan", mr: "बेलन" },
            { en: "tea thermos", mr: "चहा थर्मास" },
            { en: "vip khurchi", mr: "VIP खुर्ची" }, { en: "vip chair", mr: "VIP खुर्ची" },
            { en: "samai", mr: "समई" },
            { en: "sofa", mr: "सोफे" }, { en: "vip sofa", mr: "VIP सोफे" },
            { en: "focus", mr: "फोकस" },
            { en: "generator", mr: "जनरेटर" },
            { en: "parde", mr: "परदे" }, { en: "curtains", mr: "परदे" },
            { en: "ceiling", mr: "सिलिंग" },
            { en: "parlight", mr: "पार्लाईट" },
            { en: "drop parde", mr: "ड्रॉप परदे" },
            { en: "sound system", mr: "साऊंड सिस्टिम साधा" },
            { en: "sound system program", mr: "साऊंड सिस्टिम सांस्कृतिक कार्यक्रम" }
        ];

        function fetchRecent() {
            performSearch('recent');
        }

        window.onload = function() {
            document.getElementById('current-date').innerText = new Date().toLocaleString('en-GB');
            document.getElementById('print-date-marathi').innerHTML = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'; // Blank space for manual date
            let savedUrl = localStorage.getItem('scriptUrl');
            if (!savedUrl && DEFAULT_SCRIPT_URL.trim() !== "") { localStorage.setItem('scriptUrl', DEFAULT_SCRIPT_URL); savedUrl = DEFAULT_SCRIPT_URL; }
            if (savedUrl) document.getElementById('script-url').value = savedUrl;
            
            let gstin = localStorage.getItem('shopGstin');
            if (!gstin) { gstin = DEFAULT_GSTIN; localStorage.setItem('shopGstin', gstin); } 
            
            let storedItems = localStorage.getItem('defaultItems');
            if(storedItems) { globalDefaults = JSON.parse(storedItems); }
            initBillItems();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start-date').value = today;
            document.getElementById('end-date').value = today;
            updatePrintDates(); renderTableRows();
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
            fetchRecent();
            
            // --- AUTO-SUGGESTION LISTENER ---
            const itemInput = document.getElementById('new-item-name');
            itemInput.addEventListener('input', function() {
                const val = this.value.toLowerCase();
                const list = document.getElementById('suggestion-list');
                list.innerHTML = '';
                
                if (!val) {
                    list.classList.add('hidden');
                    return;
                }

                // Filter items
                const matches = ITEM_CATALOG.filter(i => 
                    i.en.startsWith(val) || i.mr.startsWith(val) || i.en.includes(val) || i.mr.includes(val)
                );

                if (matches.length > 0) {
                    list.classList.remove('hidden');
                    matches.slice(0, 8).forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.innerText = item.mr; // Show Marathi Name
                        div.onclick = function() {
                            itemInput.value = item.mr;
                            list.classList.add('hidden');
                            document.getElementById('new-item-price').focus();
                        };
                        list.appendChild(div);
                    });
                } else {
                    list.classList.add('hidden');
                }
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!document.getElementById('new-item-row').contains(e.target)) {
                    document.getElementById('suggestion-list').classList.add('hidden');
                }
            });
            // ---------------------------------
        };

        // --- GESTURE REMOVED --- 
        // No touchstart/touchend listeners added for tab switching

        function initBillItems() { 
             if (globalDefaults && globalDefaults.length > 0) {
                 items = globalDefaults.map(i => ({ ...i, qty: 0, days: 1 })); 
             } else {
                 items = []; 
             }
        } 
        function updateGstinDisplay(val) { /* GSTIN is static in print */ }
        
        function calculatePipes(l, w) { const l_unit = Math.ceil(l / 15); const w_unit = Math.ceil(w / 15); const vertical = (l_unit + 1) * (w_unit + 1); const horizontal = (2 * l_unit * w_unit) + l_unit + w_unit; return { v: vertical, h: horizontal }; }
        function calcDedicatedPipes() { const l = parseFloat(document.getElementById('calc-l').value) || 0; const w = parseFloat(document.getElementById('calc-w').value) || 0; if (l > 0 && w > 0) { const pipes = calculatePipes(l, w); const ceiling = Math.ceil(l/15) * Math.ceil(w/15); document.getElementById('res-v').innerText = pipes.v; document.getElementById('res-h').innerText = pipes.h; document.getElementById('res-c').innerText = ceiling; } else { document.getElementById('res-v').innerText = 0; document.getElementById('res-h').innerText = 0; document.getElementById('res-c').innerText = 0; } }
        function snapToGrid(input) { let val = parseFloat(input.value) || 0; if (val > 0 && val % 15 !== 0) { input.value = Math.round(val / 15) * 15; if(input.id.includes('calc')) calcDedicatedPipes(); } }

        function toggleMandapSeparator() {
            const sep = document.getElementById('print-mandap-separator');
            if (mandaps.length > 0) {
                sep.classList.add('visible');
            } else {
                sep.classList.remove('visible');
            }
        }

        function addMandapRow() { 
            const id = Date.now(); 
            mandaps.push({ id: id, type: 'Normal', l: '', w: '', rate: 15, total: 0, isCustom: false }); 
            renderMandapRows(); 
            toggleMandapSeparator();
        }
        function removeMandapRow(index) { 
            mandaps.splice(index, 1); 
            renderMandapRows(); 
            recalcTotals(); 
            toggleMandapSeparator();
        }
        
        let openDropdownIndex = null;
        function toggleDropdown(index) {
            if (openDropdownIndex === index) { document.getElementById(`dropdown-${index}`).classList.add('hidden'); openDropdownIndex = null; return; }
            if (openDropdownIndex !== null) { const prev = document.getElementById(`dropdown-${openDropdownIndex}`); if(prev) prev.classList.add('hidden'); }
            document.getElementById(`dropdown-${index}`).classList.remove('hidden'); openDropdownIndex = index;
        }
        window.addEventListener('click', (e) => {
            if (openDropdownIndex !== null) {
                const btn = document.querySelector(`button[onclick="toggleDropdown(${openDropdownIndex})"]`);
                const dd = document.getElementById(`dropdown-${openDropdownIndex}`);
                if (btn && dd && !btn.contains(e.target) && !dd.contains(e.target)) { dd.classList.add('hidden'); openDropdownIndex = null; }
            }
        });
        function selectPreset(index, type) {
            mandaps[index].type = type; mandaps[index].rate = MANDAP_TYPES[type]; document.getElementById(`dropdown-${index}`).classList.add('hidden'); openDropdownIndex = null; renderMandapRows(); calcMandapRow(index);
        }

        function renderMandapRows() {
            const container = document.getElementById('mandap-list-container'); container.innerHTML = '';
            mandaps.forEach((m, index) => {
                const div = document.createElement('div'); div.className = "bg-blue-50/50 rounded-xl p-3 border border-blue-100 relative mb-2 mandap-row-container";
                let dropdownItems = ''; for (const [type, _] of Object.entries(MANDAP_TYPES)) { dropdownItems += `<div onclick="selectPreset(${index}, '${type}')" class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm font-medium text-gray-700">${type}</div>`; }
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2 relative">
                        <div class="flex-1 mr-2 relative">
                            <label class="text-[10px] font-bold text-gray-400 uppercase pl-1 block text-center no-print">Type</label>
                            <div class="flex items-center gap-1 mandap-input-group no-print">
                                <input type="text" value="${m.type}" oninput="updateMandapTypeInput(${index}, this.value)" class="flex-1 bg-white border border-gray-200 rounded-lg p-1 text-xs font-bold text-gray-700 outline-none focus:border-blue-400 text-center" placeholder="Name">
                                <button onclick="toggleDropdown(${index})" class="bg-white border border-gray-200 rounded-lg px-2 py-1 hover:bg-gray-50 focus:outline-none"><i class="fas fa-chevron-down text-xs text-gray-500"></i></button>
                            </div>
                            <div id="dropdown-${index}" class="hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-xl z-20 overflow-hidden no-print">${dropdownItems}</div>
                            <span class="mandap-text-print hidden">${m.type}</span>
                        </div>
                        <button onclick="removeMandapRow(${index})" class="text-red-300 hover:text-red-500 p-1 no-print"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <div class="grid grid-cols-4 gap-2 items-end">
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase pl-1 block text-center mandap-label-print">L (ft)</label><input type="number" value="${m.l}" oninput="updateMandapVal(${index}, 'l', this.value)" class="w-full p-2 text-center text-sm font-bold text-gray-700 bg-white border border-gray-200 rounded-lg focus:border-blue-400 outline-none" placeholder="0"></div>
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase pl-1 block text-center mandap-label-print">W (ft)</label><input type="number" value="${m.w}" oninput="updateMandapVal(${index}, 'w', this.value)" class="w-full p-2 text-center text-sm font-bold text-gray-700 bg-white border border-gray-200 rounded-lg focus:border-blue-400 outline-none" placeholder="0"></div>
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase pl-1 block text-center mandap-label-print">Rate/sqft</label><input type="number" value="${m.rate}" oninput="updateMandapVal(${index}, 'rate', this.value)" class="w-full p-2 text-center text-sm font-bold text-gray-700 bg-white border border-gray-200 rounded-lg focus:border-blue-400 outline-none"></div>
                        <div><label class="text-[10px] font-bold text-blue-300 uppercase pl-1 block text-right mandap-label-print">Amount</label><div class="w-full p-2 text-right text-sm font-bold text-blue-700 bg-blue-100/50 rounded-lg mandap-amount-box">₹ <span class="mandap-amount-print" id="mandap-total-${index}">${m.total}</span></div></div>
                    </div>`;
                container.appendChild(div);
            });
        }

        function updateMandapTypeInput(index, val) { mandaps[index].type = val; const printSpan = document.querySelectorAll('.mandap-text-print')[index]; if(printSpan) printSpan.innerText = val; }
        function updateMandapVal(index, field, val) { mandaps[index][field] = val; calcMandapRow(index); }
        function calcMandapRow(index) { const m = mandaps[index]; const l = parseFloat(m.l) || 0; const w = parseFloat(m.w) || 0; const rate = parseFloat(m.rate) || 0; const globalDays = parseInt(document.getElementById('total-days').innerText) || 1; const area = l * w; const total = Math.round(area * rate * globalDays); m.total = total; const totalEl = document.getElementById(`mandap-total-${index}`); if(totalEl) totalEl.innerText = total; recalcTotals(); }
        function autoCalcAllMandaps() { mandaps.forEach((_, i) => calcMandapRow(i)); }

        function recalcTotals() {
            const mandapSum = mandaps.reduce((acc, m) => acc + (m.total || 0), 0);
            const itemsTotal = items.reduce((sum, item) => {
                const q = parseFloat(item.qty) || 0;
                const p = parseFloat(item.price) || 0;
                const d = parseFloat(item.days) || 1;
                return sum + (q * p * d);
            }, 0);
            const subtotal = mandapSum + itemsTotal; document.getElementById('subtotal').innerText = subtotal;
            const isGstEnabled = document.getElementById('gst-toggle').checked;
            const taxRows = document.getElementById('tax-rows');
            let cgstAmt = 0, sgstAmt = 0;
            if (isGstEnabled) { taxRows.classList.remove('hidden', 'no-tax-print'); cgstAmt = Math.round((subtotal * 9) / 100); sgstAmt = Math.round((subtotal * 9) / 100); } else { taxRows.classList.add('hidden', 'no-tax-print'); }
            document.getElementById('cgst-amt').innerText = cgstAmt; document.getElementById('sgst-amt').innerText = sgstAmt;
            const total = subtotal + cgstAmt + sgstAmt; document.getElementById('final-total').innerText = total;
            const paid = parseFloat(document.getElementById('paid-amount').value) || 0;
            document.getElementById('balance-due').innerText = total - paid; document.getElementById('print-paid').innerText = paid; document.getElementById('print-balance').innerText = total - paid;
        }
        function recalcGrandTotalsOnly() { recalcTotals(); }

        // --- Render Rows with Editable Name & Up/Down Buttons ---
        function renderTableRows() {
            const tbody = document.getElementById('items-list'); tbody.innerHTML = '';
            items.forEach((item, index) => {
                // Ensure text can be entered and parsed. If NaN, it treats as 0 for calculation but keeps text in input.
                const qtyVal = item.qty; 
                const priceVal = item.price;
                
                // For calculation display
                const q = parseFloat(qtyVal) || 0;
                const p = parseFloat(priceVal) || 0;
                const d = parseFloat(item.days) || 1;
                const itemTotal = q * p * d; 
                
                const tr = document.createElement('tr'); 
                tr.className = 'group hover:bg-gray-50 transition-colors';
                const daysVal = item.days === 0 ? '' : item.days;
                
                tr.innerHTML = `
                <td class="p-2 pl-3">
                    <input type="text" value="${item.name}" oninput="updateItemName(${index}, this.value)" class="w-full text-sm font-medium text-gray-700 bg-transparent border-none focus:ring-0">
                </td>
                <td class="p-1 text-center"><input type="text" oninput="handleRowInput(${index}, 'qty', this.value)" value="${qtyVal}" class="w-full text-center bg-gray-100 rounded-lg p-1 focus:bg-white focus:ring-2 focus:ring-primary/20 outline-none font-bold text-primary" placeholder="0"></td>
                <td class="p-1 text-center"><input type="text" oninput="handleRowInput(${index}, 'price', this.value)" value="${priceVal}" class="w-full text-center bg-transparent border-b border-gray-100 focus:border-primary outline-none p-1" placeholder="0"></td>
                <td class="p-1 text-center bg-yellow-50/50"><input type="number" oninput="handleRowInput(${index}, 'days', this.value)" value="${daysVal}" class="w-full text-center bg-transparent border-b border-yellow-200 focus:border-yellow-500 outline-none font-bold text-yellow-700 p-1" placeholder="0"></td>
                <td class="p-2 pr-3 text-right font-bold text-gray-800">₹ <span id="item-total-${index}">${itemTotal}</span></td>
                <td class="no-print text-center p-1 row-actions flex justify-end gap-1">
                    <button onclick="moveItem(${index}, -1)" class="text-gray-400 hover:text-blue-500"><i class="fas fa-arrow-up"></i></button>
                    <button onclick="moveItem(${index}, 1)" class="text-gray-400 hover:text-blue-500"><i class="fas fa-arrow-down"></i></button>
                    <button onclick="deleteItem(${index})" class="text-red-300 hover:text-red-500 ml-1"><i class="fas fa-trash-alt text-xs"></i></button>
                </td>`;
                tbody.appendChild(tr);
            }); 
            recalcTotals();
        }

        function updateItemName(index, val) { items[index].name = val; }
        
        function handleRowInput(index, field, value) {
            items[index][field] = value; // Store raw value (string or number)
            
            // Calculate for specific row display immediately
            const q = parseFloat(items[index].qty) || 0;
            const p = parseFloat(items[index].price) || 0;
            const d = parseFloat(items[index].days) || 1;
            const newRowTotal = q * p * d;
            
            const span = document.getElementById(`item-total-${index}`);
            if(span) span.innerText = newRowTotal;
            
            recalcTotals(); 
        }
        
        function addNewItem() { const name = document.getElementById('new-item-name').value; const price = document.getElementById('new-item-price').value; const globalDays = parseInt(document.getElementById('total-days').innerText) || 1; if (name) { items.push({ id: Date.now(), name, price: price, qty: 0, days: globalDays }); renderTableRows(); document.getElementById('new-item-name').value = ''; document.getElementById('new-item-price').value = ''; } }
        function deleteItem(index) { if(confirm('Remove?')) { items.splice(index, 1); renderTableRows(); } }
        
        function moveItem(index, direction) {
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < items.length) {
                const temp = items[index];
                items[index] = items[newIndex];
                items[newIndex] = temp;
                renderTableRows();
            }
        }

        function calcDays() { const startStr = document.getElementById('start-date').value; const endStr = document.getElementById('end-date').value; if(startStr && endStr) { const diffTime = new Date(endStr) - new Date(startStr); let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; if (diffDays < 1) diffDays = 1; document.getElementById('total-days').innerText = diffDays; document.getElementById('print-total-days').innerText = diffDays; updatePrintDates(); items.forEach(item => item.days = diffDays); renderTableRows(); autoCalcAllMandaps(); } }
        function updatePrintDates() { const s = new Date(document.getElementById('start-date').value); const e = new Date(document.getElementById('end-date').value); document.getElementById('print-start-date').innerText = s.toLocaleDateString('en-GB'); document.getElementById('print-end-date').innerText = e.toLocaleDateString('en-GB'); }
        
        function preparePrint() {
            // FIX: Explicitly set values for print spans from inputs
            document.getElementById('p-cust-name-display').innerText = document.getElementById('cust-name').value;
            document.getElementById('p-cust-phone-display').innerText = document.getElementById('cust-phone').value;
            
            const custName = document.getElementById('cust-name').value || "Bill";
            const dateStr = new Date().toISOString().split('T')[0];
            document.title = `${custName}_${dateStr}`;
            document.getElementById('print-footer-custom').innerText = document.getElementById('footer-text-input').value;
        }

        async function saveAndPrintBill(docType = 'BILL') {
            const custName = document.getElementById('cust-name').value; if (!custName) { showToast("Enter Customer Name", "error"); return; }
            
            // Prepare Print Data BEFORE printing
            preparePrint();
            
            const doc = document.documentElement;
            if(docType === 'QUOTATION') {
                doc.classList.add('quotation-mode'); doc.classList.remove('invoice-mode'); 
                document.getElementById('print-doc-type').innerText = "कोटेशन";
            } else {
                doc.classList.add('invoice-mode'); doc.classList.remove('quotation-mode'); 
                document.getElementById('print-doc-type').innerText = "इन्व्हॉइस";
            }

            const btn = document.getElementById('btn-save-print'); const originalText = btn.innerHTML; const scriptUrl = localStorage.getItem('scriptUrl') || DEFAULT_SCRIPT_URL; 
            let printTriggered = false; const triggerPrint = () => { if(!printTriggered) { printTriggered = true; btn.innerHTML = originalText; window.print(); } };
            document.getElementById('current-date').innerText = new Date().toLocaleString('en-GB'); 
            
            let detailsArray = [];
            mandaps.forEach(m => { 
                if (m.total > 0) { 
                    const area = (parseFloat(m.l) || 0) * (parseFloat(m.w) || 0);
                    detailsArray.push(`MANDAP [${m.type}]: ${m.l}x${m.w}ft (${area} sq.ft) @${m.rate} (Rs ${m.total})`); 
                } 
            });
            items.forEach(i => { 
                // Save even if qty is text or 0, just push string
                detailsArray.push(`${i.name}: ${i.qty}* x ${i.days}d @${i.price}`); 
            });
            const finalDetailsString = detailsArray.join('\n');
            const payload = { action: editingRowIndex ? 'edit' : 'create', row: editingRowIndex, name: custName, phone: document.getElementById('cust-phone').value, startDate: document.getElementById('start-date').value, endDate: document.getElementById('end-date').value, days: document.getElementById('total-days').innerText, details: finalDetailsString, subtotal: document.getElementById('subtotal').innerText, cgst: document.getElementById('cgst-amt').innerText, sgst: document.getElementById('sgst-amt').innerText, total: document.getElementById('final-total').innerText, paid: document.getElementById('paid-amount').value || 0, docType: docType };
                
            if (scriptUrl) {
                btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Saving...'; 
                
                // Print First (Data is ready)
                setTimeout(triggerPrint, 500);

                try { 
                    await fetch(scriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); 
                    showToast(editingRowIndex ? "Updated!" : "Saved!", "success"); 
                    
                    // REFRESH AFTER 5 SECONDS
                    setTimeout(() => {
                        fetchRecent();
                        if(editingRowIndex) exitEditMode();
                    }, 5000); 

                } catch (error) { console.error(error); showToast("Network Error", "error"); }
            } else { showToast("Script URL Missing", "error"); triggerPrint(); }
        }

        // --- Common & Settings ---
        function switchTab(tab) {
            const newView = document.getElementById('view-new-bill'); const searchView = document.getElementById('view-search'); const calcView = document.getElementById('view-pipe-calc');
            const fab = document.getElementById('fab-container'); const btnNew = document.getElementById('tab-new'); const btnSearch = document.getElementById('tab-search'); const btnCalc = document.getElementById('tab-calc');
            const activeClass = ["bg-primary", "text-white", "shadow-md"]; const inactiveClass = ["text-gray-500", "hover:bg-gray-50"];
            [newView, searchView, calcView].forEach(v => v.classList.add('hidden')); [btnNew, btnSearch, btnCalc].forEach(b => { b.classList.remove(...activeClass); b.classList.add(...inactiveClass); });
            activeTab = tab; 
            if(tab === 'new') { newView.classList.remove('hidden'); fab.classList.remove('hidden'); btnNew.classList.add(...activeClass); btnNew.classList.remove(...inactiveClass); } 
            else if (tab === 'search') { searchView.classList.remove('hidden'); fab.classList.add('hidden'); btnSearch.classList.add(...activeClass); btnSearch.classList.remove(...inactiveClass); fetchRecent(); } 
            else if (tab === 'calc') { calcView.classList.remove('hidden'); fab.classList.add('hidden'); btnCalc.classList.add(...activeClass); btnCalc.classList.remove(...inactiveClass); }
        }

        // --- HISTORY TABS LOGIC ---
        function setHistoryFilter(type) {
            currentHistoryFilter = type;
            const btnBills = document.getElementById('btn-hist-bills');
            const btnQuotes = document.getElementById('btn-hist-quotes');
            
            if(type === 'BILL') {
                btnBills.classList.add('tab-btn-active'); btnBills.classList.remove('tab-btn-inactive');
                btnQuotes.classList.remove('tab-btn-active'); btnQuotes.classList.add('tab-btn-inactive');
            } else {
                btnQuotes.classList.add('tab-btn-active'); btnQuotes.classList.remove('tab-btn-inactive');
                btnBills.classList.remove('tab-btn-active'); btnBills.classList.add('tab-btn-inactive');
            }
            renderHistoryList(); // Re-render with local filter
        }

        function renderHistoryList() {
            const resultDiv = document.getElementById('search-results');
            const filteredData = allFetchedData.filter(item => {
                // If docType is missing, assume BILL.
                // If status is "Quotation", treat as QUOTATION (fallback for older logic)
                let type = item.docType || "BILL";
                if(item.status === "Quotation") type = "QUOTATION";
                
                return type === currentHistoryFilter;
            });

            resultDiv.innerHTML = '';
            if(filteredData.length === 0) { resultDiv.innerHTML = '<div class="text-center text-gray-400 mt-12 py-10 bg-gray-50 rounded-2xl border border-dashed border-gray-200"><i class="far fa-folder-open text-4xl mb-2"></i><br>No records found</div>'; return; }
            
            const today = new Date(); today.setHours(0,0,0,0);
            
            filteredData.forEach(bill => {
                if(bill.name.toLowerCase() === 'name') return;
                const isPaid = bill.status === 'Paid'; 
                const displayDate = new Date(bill.date).toLocaleDateString('en-GB'); 
                const dataStr = encodeURIComponent(JSON.stringify(bill)); 
                const endDate = new Date(bill.endDate || bill.date); 
                const isOngoing = !isPaid && endDate >= today;
                const paid = parseFloat(bill.paid) || 0; 
                const total = parseFloat(bill.total) || 0; 
                const balance = total - paid;
                
                let cardClass, textClass, statusIcon, statusText;
                
                // Use the derived type or original docType
                const isQuotation = (bill.docType === 'QUOTATION' || bill.status === 'Quotation');

                if (isQuotation) {
                    cardClass = "bg-gray-50 border-gray-200"; textClass = "text-gray-600"; statusIcon = "fa-file-alt"; statusText = "Quotation";
                } else if (isPaid) { 
                    cardClass = "bg-green-50 border-green-200"; textClass = "text-green-700"; statusIcon = "fa-check-circle"; statusText = "Paid"; 
                } else if (isOngoing) { 
                    cardClass = "bg-blue-50 border-blue-200"; textClass = "text-blue-700"; statusIcon = "fa-hourglass-half"; statusText = "Ongoing"; 
                } else { 
                    cardClass = "bg-red-50 border-red-200"; textClass = "text-red-700"; statusIcon = "fa-exclamation-circle"; statusText = "Pending"; 
                }
                
                let actionButtons = '';
                if (isQuotation) {
                    // Quotations have Edit and Delete only (convert to bill by editing)
                    actionButtons = `<button onclick="editInvoice(${bill.rowIndex}, '${dataStr}')" class="flex-1 py-2 bg-white text-blue-600 rounded-lg text-sm font-bold flex items-center justify-center gap-2 hover:bg-blue-50 transition-colors shadow-sm border border-gray-100"><i class="fas fa-pen"></i> Edit</button>
                                     <button onclick="directPrint(${bill.rowIndex}, '${dataStr}')" class="flex-1 py-2 bg-white text-gray-700 rounded-lg text-sm font-bold flex items-center justify-center gap-2 hover:bg-gray-50 transition-colors shadow-sm border border-gray-100"><i class="fas fa-print"></i> Print</button>
                                     <button onclick="deleteInvoice(${bill.rowIndex})" class="w-10 flex items-center justify-center bg-white text-red-500 rounded-lg hover:bg-red-50 transition-colors shadow-sm border border-gray-100"><i class="fas fa-trash-alt"></i></button>`;
                } else {
                    actionButtons = `<button onclick="editInvoice(${bill.rowIndex}, '${dataStr}')" class="flex-1 py-2 bg-white text-blue-600 rounded-lg text-sm font-bold flex items-center justify-center gap-2 hover:bg-blue-50 transition-colors shadow-sm border border-gray-100"><i class="fas fa-pen"></i> Edit</button>
                                     ${!isPaid ? `<button onclick="openPaymentModal(${bill.rowIndex})" class="flex-1 py-2 bg-white text-green-600 rounded-lg text-sm font-bold flex items-center justify-center gap-2 hover:bg-green-50 transition-colors shadow-sm border border-gray-100"><i class="fas fa-plus"></i> Pay</button>` : ''}
                                     <button onclick="directPrint(${bill.rowIndex}, '${dataStr}')" class="flex-1 py-2 bg-white text-gray-700 rounded-lg text-sm font-bold flex items-center justify-center gap-2 hover:bg-gray-50 transition-colors shadow-sm border border-gray-100"><i class="fas fa-print"></i> Print</button>
                                     <button onclick="deleteInvoice(${bill.rowIndex})" class="w-10 flex items-center justify-center bg-white text-red-500 rounded-lg hover:bg-red-50 transition-colors shadow-sm border border-gray-100"><i class="fas fa-trash-alt"></i></button>`;
                }

                const html = `
                    <div class="${cardClass} p-5 rounded-2xl shadow-sm border hover:shadow-md transition-shadow relative overflow-hidden group">
                        <div class="flex justify-between items-start mb-3 pr-4">
                            <div><h3 class="font-bold text-gray-900 text-lg">${bill.name}</h3><a href="tel:${bill.phone}" class="flex items-center gap-2 text-gray-500 text-sm mt-1 hover:text-primary transition-colors"><i class="fas fa-phone text-xs transform flip-horizontal"></i> ${bill.phone}</a><div class="flex items-center gap-2 text-gray-400 text-xs mt-1"><i class="far fa-clock"></i> ${displayDate}</div></div>
                            <div class="text-right"><div class="text-xl font-bold ${balance > 0 && !isQuotation ? 'text-red-600' : 'text-gray-600'}">${isQuotation ? 'Total' : 'Bal'}: ₹ ${isQuotation ? total : balance}</div><span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold ${textClass} bg-white/50 border border-white mt-1"><i class="fas ${statusIcon}"></i> ${statusText}</span></div>
                        </div>
                        ${!isQuotation ? `<div class="mb-3 px-1 pt-2 border-t border-gray-200/50"><div class="flex justify-between text-xs text-gray-600 font-medium"><span><i class="fas fa-check-circle text-green-500 mr-1"></i> Paid: ₹${paid}</span><span class="text-gray-400">Total Bill: ₹${total}</span></div></div>` : ''}
                        <div class="flex gap-2 pt-2 border-t border-gray-200/50">
                            ${actionButtons}
                        </div>
                    </div>`;
                resultDiv.insertAdjacentHTML('beforeend', html);
            });
        }
        
        async function directPrint(rowIndex, dataStr) {
            // Load data into edit mode temporarily
            await editInvoice(rowIndex, dataStr);
            // Wait slightly for DOM update then print
            setTimeout(() => {
                const docType = document.documentElement.classList.contains('quotation-mode') ? 'QUOTATION' : 'BILL';
                saveAndPrintBill(docType); // Re-uses save function but effectively just reprints existing data since IDs match
            }, 500);
        }

        async function performSearch(type = 'search') {
            const query = document.getElementById('search-query').value; const dateVal = document.getElementById('search-date').value; 
            const scriptUrl = localStorage.getItem('scriptUrl') || DEFAULT_SCRIPT_URL; const resultDiv = document.getElementById('search-results');
            if(!scriptUrl) { showToast("Setup settings first", "error"); return; }
            if(type === 'search' && !query && !dateVal) { showToast("Enter text or pick date", "error"); return; }
            resultDiv.innerHTML = '<div class="text-center mt-12"><i class="fas fa-circle-notch fa-spin text-3xl text-primary mb-3"></i><p class="text-gray-500 font-medium">Fetching Records...</p></div>';
            
            let url = `${scriptUrl}?q=${encodeURIComponent(query)}&date=${dateVal}`; 
            if(type === 'recent') url = `${scriptUrl}?type=recent&ts=${Date.now()}`;

            try {
                const response = await fetch(url); let data = await response.json();
                data.sort((a, b) => (b.rowIndex || 0) - (a.rowIndex || 0));
                
                // Store globally for filtering
                allFetchedData = data;
                renderHistoryList(); // Render based on current filter (Bill/Quotation)

            } catch(e) { console.error(e); resultDiv.innerHTML = '<div class="text-center text-red-400 mt-10">Error loading data.</div>'; }
        }

        function toggleSettings() { const m = document.getElementById('settings-modal'); if(m.classList.contains('hidden')) { m.classList.remove('hidden'); m.classList.add('flex'); renderSettingsList(); } else { m.classList.add('hidden'); m.classList.remove('flex'); } }
        function renderSettingsList() { const container = document.getElementById('settings-items-list'); container.innerHTML = ''; globalDefaults.forEach((item, index) => { const div = document.createElement('div'); div.className = "flex gap-2 items-center"; div.innerHTML = `<input type="text" value="${item.name}" onchange="updateDefaultItem(${index}, 'name', this.value)" class="flex-1 px-2 py-1 border rounded text-xs bg-gray-50"><input type="number" value="${item.price}" onchange="updateDefaultItem(${index}, 'price', this.value)" class="w-16 px-2 py-1 border rounded text-xs bg-gray-50 text-center"><button onclick="removeSettingsRow(${index})" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button>`; container.appendChild(div); }); }
        function updateDefaultItem(i, f, v) { if(f==='price') globalDefaults[i][f]=parseFloat(v)||0; else globalDefaults[i][f]=v; }
        function addSettingsRow() { globalDefaults.push({ id: Date.now(), name: 'New Item', price: 0 }); renderSettingsList(); }
        function removeSettingsRow(i) { globalDefaults.splice(i, 1); renderSettingsList(); }
        function saveSettings() { localStorage.setItem('scriptUrl', document.getElementById('script-url').value); localStorage.setItem('shopGstin', document.getElementById('shop-gstin').value); localStorage.setItem('defaultItems', JSON.stringify(globalDefaults)); updateGstinDisplay(document.getElementById('shop-gstin').value); toggleSettings(); showToast("Settings Saved!", "success"); }
        function openPaymentModal(row) { currentPaymentRow = row; document.getElementById('modal-payment-amount').value = ''; const m = document.getElementById('payment-modal'); m.classList.remove('hidden'); m.classList.add('flex'); document.getElementById('modal-payment-amount').focus(); }
        function closePaymentModal() { const m = document.getElementById('payment-modal'); m.classList.add('hidden'); m.classList.remove('flex'); currentPaymentRow = null; }
        function showToast(message, type) { const t = document.getElementById('toast'); const i = document.getElementById('toast-icon'); document.getElementById('toast-message').innerText = message; t.className = "fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 z-50 transition-all duration-300 min-w-[280px] justify-center text-white font-medium " + (type === 'success' ? 'bg-secondary' : type === 'error' ? 'bg-red-500' : 'bg-gray-900'); i.className = type === 'success' ? "fas fa-check-circle" : type === 'error' ? "fas fa-exclamation-circle" : "fas fa-info-circle"; t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 4000); }
        async function submitPayment() { const amt = document.getElementById('modal-payment-amount').value; if(!amt) return showToast("Enter an amount", "error"); const btn = document.getElementById('btn-confirm-pay'); const orig = btn.innerHTML; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>'; btn.disabled = true; const url = localStorage.getItem('scriptUrl') || DEFAULT_SCRIPT_URL; try { await fetch(url, { method: 'POST', mode: 'no-cors', headers: {'Content-Type':'application/json'}, body: JSON.stringify({action: 'update_payment', row: currentPaymentRow, amount: amt}) }); showToast("Payment Added!", "success"); closePaymentModal(); setTimeout(fetchRecent, 1500); } catch(e) { showToast("Network Error", "error"); } finally { btn.innerHTML = orig; btn.disabled = false; } }
        async function deleteInvoice(rowIndex) { if(!confirm("Delete this invoice?")) return; const scriptUrl = localStorage.getItem('scriptUrl') || DEFAULT_SCRIPT_URL; try { await fetch(scriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'delete', row: rowIndex }) }); showToast("Deleted!", "success"); setTimeout(() => fetchRecent(), 1500); } catch(e) { showToast("Delete failed", "error"); } }

        async function editInvoice(rowIndex, dataStr) {
            const data = JSON.parse(decodeURIComponent(dataStr)); editingRowIndex = rowIndex;
            document.getElementById('edit-mode-bar').classList.remove('hidden');
            document.getElementById('cust-name').value = data.name; document.getElementById('cust-phone').value = data.phone;
            try { document.getElementById('start-date').value = new Date(data.startDate).toISOString().split('T')[0]; document.getElementById('end-date').value = new Date(data.endDate).toISOString().split('T')[0]; } catch(e) {}
            calcDays(); items.forEach(i => { i.qty = 0; i.days = 1; }); document.getElementById('paid-amount').value = data.paid || 0;
            mandaps = [];
            const lines = data.details.split('\n');
            lines.forEach(line => {
                if (line.includes('MANDAP')) { 
                    // FIXED REGEX to handle flexible middle content like area
                    const match = line.match(/MANDAP \[(.*?)\]: (\d+)x(\d+)ft.*?@(\d+) \(Rs (\d+)\)/);
                    if(match) { mandaps.push({ id: Date.now() + Math.random(), type: match[1], l: match[2], w: match[3], rate: parseFloat(match[4]), total: parseFloat(match[5]), isCustom: false }); } 
                } else { 
                    // Updated Regex to catch the rate @
                    const parts = line.split(':'); 
                    if(parts.length > 1) { 
                        const name = parts[0].trim(); 
                        // Match qty, days, and OPTIONAL rate
                        const nums = parts[1].match(/(.*?)\* x (\d+)d(?: @(.*))?/); 
                        if(nums) { 
                            const foundItem = items.find(i => i.name === name); 
                            // If rate (group 3) found, use it, else 0
                            const qty = nums[1].trim(); // Text Qty
                            const rate = nums[3] ? nums[3].trim() : 0; // Text Rate
                            
                            if(foundItem) { 
                                foundItem.qty = qty; 
                                foundItem.days = parseInt(nums[2]); 
                                foundItem.price = rate; 
                            } else { 
                                items.push({ id: Date.now(), name: name, price: rate, qty: qty, days: parseInt(nums[2]) }); 
                            } 
                        } 
                    } 
                }
            });
            renderMandapRows(); document.getElementById('gst-toggle').checked = false; switchTab('new'); renderTableRows(); showToast("Invoice Loaded", "success");
            
            // Set Doc Type based on loaded data
            if(data.docType === 'QUOTATION') {
                document.documentElement.classList.add('quotation-mode');
                document.documentElement.classList.remove('invoice-mode');
            } else {
                document.documentElement.classList.add('invoice-mode');
                document.documentElement.classList.remove('quotation-mode');
            }
        }
        function exitEditMode() { editingRowIndex = null; document.getElementById('edit-mode-bar').classList.add('hidden'); document.getElementById('cust-name').value = ""; document.getElementById('cust-phone').value = ""; items.forEach(i => { i.qty = 0; i.days = 1; }); mandaps = []; renderMandapRows(); document.getElementById('paid-amount').value = ''; renderTableRows(); showToast("Edit cancelled", "info"); }
    </script>
</body>
</html>
