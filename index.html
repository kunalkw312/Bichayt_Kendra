<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bichayt Kendra Manager</title>
    
    <meta name="theme-color" content="#4f46e5">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: { primary: '#4f46e5', primaryDark: '#4338ca', secondary: '#10b981' },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out', 'slide-up': 'slideUp 0.4s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }, slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } } }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .custom-scroll::-webkit-scrollbar { height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* === PRINT STYLES === */
        @media print {
            @page { size: A4; margin: 5mm 8mm; }
            body { background: white; margin: 0; padding: 0; font-family: 'Inter', sans-serif; color: black; filter: grayscale(100%); }
            .no-print, #tab-nav, #settings-modal, #toast, #btn-install, .fab-button, .gst-toggle-container { display: none !important; }
            #main-container { box-shadow: none !important; border: none !important; margin: 0 !important; width: 100% !important; max-width: 100% !important; padding: 0 !important; }
            .print-header { border-bottom: 2px solid black; margin-bottom: 10px; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: flex-start; }
            .print-title { font-size: 20pt; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; line-height: 1; }
            .print-meta { text-align: right; font-size: 9pt; line-height: 1.4; }
            .gstin-display { font-size: 9pt; font-weight: bold; margin-top: 2px; display: block !important; }
            .print-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 10px; }
            .bg-blue-50, .bg-yellow-50, .bg-white, .shadow-lg, .rounded-2xl, .rounded-xl { background: none !important; box-shadow: none !important; border: none !important; padding: 0 !important; margin: 0 !important; }
            .border-b-2 { border-bottom: 1px solid #ccc !important; }
            input { border: none !important; background: transparent !important; padding: 0 !important; height: auto !important; width: 100% !important; font-weight: 500; font-size: 10pt; }
            table { width: 100% !important; border-collapse: collapse; margin-top: 5px; }
            th { border-bottom: 1px solid black; text-align: left; padding: 2px 4px; font-size: 9pt; font-weight: bold; text-transform: uppercase; }
            td { border-bottom: 1px solid #eee; padding: 2px 4px; font-size: 9.5pt; }
            .text-center { text-align: center; } .text-right { text-align: right; }
            .totals-section { float: right; width: 45%; margin-top: 10px; border-top: 1px solid black; padding-top: 5px; }
            .totals-row { display: flex; justify-content: space-between; margin-bottom: 2px; font-size: 10pt; }
            .totals-final { font-size: 12pt; font-weight: bold; margin-top: 5px; border-top: 1px solid #ccc; padding-top: 2px; }
            .print-footer { position: fixed; bottom: 0; left: 0; right: 0; text-align: center; font-size: 8pt; color: #000; padding-bottom: 5mm; }
            .signatures { display: flex; justify-content: space-between; margin-top: 30px; margin-bottom: 10px; px: 10mm; }
            .sig-line { border-top: 1px solid black; width: 120px; padding-top: 2px; font-weight: bold; font-size: 9pt; }
            .show-print { display: block !important; } .hide-print { display: none !important; } .no-tax-print { display: none !important; }
            .print\:hidden { display: none !important; }
        }
        .show-print, .gstin-display { display: none; }
    </style>
</head>
<body class="text-gray-700">

    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 z-50 hidden transition-all duration-300 min-w-[280px] justify-center">
        <i id="toast-icon" class="fas fa-info-circle text-lg"></i><span id="toast-message" class="font-medium">Notification</span>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4 transition-opacity duration-300 no-print">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-slide-up">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-gray-800 text-lg">⚙️ Settings</h3>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div><label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Google Sheet URL</label><input type="text" id="script-url" class="w-full px-4 py-3 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all text-sm" placeholder="Paste Web App URL..."></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">GSTIN Number</label><input type="text" id="shop-gstin" class="w-full px-4 py-3 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all text-sm uppercase" placeholder="e.g. 22AAAAA0000A1Z5"></div>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end gap-3"><button onclick="toggleSettings()" class="px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-200 rounded-lg">Close</button><button onclick="saveSettings()" class="px-6 py-2 text-sm font-bold text-white bg-primary hover:bg-primaryDark rounded-lg shadow-lg">Save</button></div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="max-w-5xl mx-auto min-h-screen flex flex-col">
        
        <!-- HEADER -->
        <div class="px-4 py-5 flex justify-between items-center no-print">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-primary to-purple-600 rounded-xl flex items-center justify-center text-white shadow-lg"><i class="fas fa-campground"></i></div>
                <div><h1 class="text-lg font-bold text-gray-900 leading-tight">Bichayt Kendra</h1><p class="text-xs text-gray-500 font-medium">Management System</p></div>
            </div>
            <div class="flex gap-2">
                <button id="btn-install" class="hidden bg-white text-primary border border-primary/20 px-3 py-1.5 rounded-full text-xs font-bold shadow-sm hover:bg-primary/5 transition-colors"><i class="fas fa-download mr-1"></i> Install</button>
                <button onclick="toggleSettings()" class="w-10 h-10 bg-white text-gray-500 rounded-full shadow-sm border border-gray-100 flex items-center justify-center hover:text-primary hover:border-primary/30 transition-all"><i class="fas fa-cog"></i></button>
            </div>
        </div>

        <!-- TABS -->
        <div id="tab-nav" class="px-4 mb-6 no-print">
            <div class="bg-white p-1.5 rounded-xl shadow-sm border border-gray-100 flex gap-1">
                <button onclick="switchTab('new')" id="tab-new" class="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2 bg-primary text-white shadow-md"><i class="fas fa-file-invoice"></i> New Bill</button>
                <button onclick="switchTab('search')" id="tab-search" class="flex-1 py-2.5 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 transition-all duration-300 flex items-center justify-center gap-2"><i class="fas fa-search"></i> Search History</button>
            </div>
        </div>

        <!-- === VIEW: NEW BILL === -->
        <div id="view-new-bill" class="flex-grow flex flex-col px-4 pb-24 animate-fade-in">
            <div id="main-container" class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden relative">
                
                <!-- VISUAL HEADER -->
                <div class="bg-gradient-to-r from-primary to-purple-700 p-6 text-white no-print">
                    <div class="flex justify-between items-start">
                        <div><h2 class="text-2xl font-bold tracking-tight">Invoice</h2><p class="text-white/80 text-sm mt-0.5">Bichayt Kendra & Events</p><p class="text-white/60 text-xs mt-1 font-mono uppercase" id="screen-gstin-display"></p></div>
                        <div class="text-right bg-white/10 px-3 py-1 rounded-lg backdrop-blur-sm border border-white/20"><div class="text-xs text-white/70 uppercase font-bold tracking-wider">Date</div><div class="text-sm font-mono font-bold" id="current-date">...</div></div>
                    </div>
                    <div id="edit-mode-bar" class="hidden mt-4 bg-yellow-400/20 border border-yellow-400/50 rounded-lg p-2 flex justify-between items-center"><span class="text-xs font-bold text-yellow-200 flex items-center gap-2"><i class="fas fa-edit"></i> Editing Old Bill</span><button onclick="exitEditMode()" class="text-xs bg-white text-yellow-700 px-2 py-1 rounded font-bold hover:bg-yellow-50">Cancel</button></div>
                </div>

                <!-- PRINT HEADER -->
                <div class="print-header show-print">
                    <div><div class="print-title">Invoice</div><div>Bichayt Kendra & Events</div><div class="gstin-display" id="print-gstin-display"></div></div>
                    <div class="print-meta">Date: <span id="print-date-text"></span><br>ID: <span id="print-id-text">...</span></div>
                </div>

                <div class="p-4 md:p-6">
                    <!-- Customer & Dates -->
                    <div class="print-grid grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="space-y-4 print-col">
                            <div class="relative group"><label class="absolute -top-2.5 left-3 bg-white px-1 text-xs font-bold text-primary group-focus-within:text-primary transition-colors">Customer Name</label><input type="text" id="cust-name" class="w-full p-3 border-2 border-gray-100 rounded-xl outline-none focus:border-primary font-medium text-sm"></div>
                            <div class="relative group"><label class="absolute -top-2.5 left-3 bg-white px-1 text-xs font-bold text-gray-500 group-focus-within:text-primary transition-colors">Phone Number</label><input type="number" id="cust-phone" class="w-full p-3 border-2 border-gray-100 rounded-xl outline-none focus:border-primary font-medium text-sm"></div>
                        </div>
                        <div class="print-col bg-yellow-50/50 p-4 rounded-xl border border-yellow-100 hide-print">
                            <div class="flex justify-between items-center mb-3"><label class="text-xs font-bold text-yellow-700 uppercase tracking-wider">Function Dates</label><span class="bg-yellow-100 text-yellow-800 text-[10px] font-bold px-2 py-0.5 rounded-full">Global</span></div>
                            <div class="flex gap-2">
                                <div class="flex-1"><span class="text-[10px] text-gray-400 block mb-1 font-bold pl-1">START</span><input type="date" id="start-date" onchange="calcDays()" class="w-full p-1.5 bg-white border border-gray-200 rounded-lg text-xs font-medium focus:border-yellow-400 outline-none"></div>
                                <div class="flex-1"><span class="text-[10px] text-gray-400 block mb-1 font-bold pl-1">END</span><input type="date" id="end-date" onchange="calcDays()" class="w-full p-1.5 bg-white border border-gray-200 rounded-lg text-xs font-medium focus:border-yellow-400 outline-none"></div>
                            </div>
                            <div class="mt-3 flex justify-end"><div class="text-xs font-bold text-gray-700 bg-white px-3 py-1 rounded-lg border border-gray-100 shadow-sm">Total: <span class="text-yellow-600 text-base" id="total-days">1</span> Days</div></div>
                        </div>
                        <div class="show-print print-col"><strong>Duration:</strong> <span id="print-total-days">1</span> Days<br>From: <span id="print-start-date"></span><br>To: &nbsp;&nbsp;&nbsp;&nbsp;<span id="print-end-date"></span></div>
                    </div>

                    <!-- Mandap -->
                    <div id="mandap-section" class="mb-6">
                        <div class="bg-blue-50/50 rounded-xl p-4 border border-blue-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 bg-blue-100 text-blue-600 text-[10px] font-bold px-3 py-1 rounded-bl-xl no-print">MANDAP AREA</div>
                            <div class="flex items-center gap-2 mb-3"><div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 no-print text-xs"><i class="fas fa-dungeon"></i></div><h3 class="font-bold text-gray-800 text-sm">Mandap / Tent</h3></div>
                            <div class="grid grid-cols-3 gap-3 items-end">
                                <!-- Replaced value="0" with placeholder="0" -->
                                <div><label class="text-[10px] font-bold text-gray-400 uppercase pl-1 mb-1 block">Length (ft)</label><input type="number" id="mandap-l" placeholder="0" oninput="recalcGrandTotalsOnly()" class="w-full p-2 text-center text-base font-bold text-gray-700 bg-white border border-gray-200 rounded-lg focus:border-blue-400 outline-none"></div>
                                <div class="flex justify-center pb-3 text-gray-300 font-bold text-lg">×</div>
                                <div><label class="text-[10px] font-bold text-gray-400 uppercase pl-1 mb-1 block">Width (ft)</label><input type="number" id="mandap-w" placeholder="0" oninput="recalcGrandTotalsOnly()" class="w-full p-2 text-center text-base font-bold text-gray-700 bg-white border border-gray-200 rounded-lg focus:border-blue-400 outline-none"></div>
                            </div>
                            <div class="mt-3 pt-2 border-t border-blue-100 flex justify-between items-center"><div class="text-xs text-blue-400 font-medium" id="mandap-details">Size: 0x0</div><div class="text-lg font-bold text-blue-700">₹ <span id="mandap-price">0</span></div></div>
                        </div>
                    </div>

                    <!-- Items -->
                    <div class="mb-6">
                        <div class="flex justify-between items-end mb-2 no-print"><h3 class="font-bold text-gray-800 text-base">Items</h3><span class="text-[10px] text-gray-400">Scroll ></span></div>
                        <div class="overflow-x-auto custom-scroll pb-2 border border-gray-100 rounded-xl">
                            <table class="w-full min-w-full">
                                <thead class="bg-gray-50 border-b border-gray-100"><tr class="text-[10px] md:text-xs font-bold text-gray-400 uppercase text-left"><th class="p-2 pl-3 w-[40%]">Item</th><th class="p-2 text-center w-[15%]">Rate</th><th class="p-2 text-center w-[10%]">Qty</th><th class="p-2 text-center w-[10%] bg-yellow-50/50 text-yellow-600">Days</th><th class="p-2 text-right pr-3 w-[20%]">Total</th><th class="p-2 w-[5%] no-print"></th></tr></thead>
                                <tbody id="items-list" class="divide-y divide-gray-50 text-xs md:text-sm"></tbody>
                            </table>
                        </div>
                        <div class="mt-2 flex gap-2 no-print p-2 bg-gray-50 rounded-xl border border-dashed border-gray-300"><input type="text" id="new-item-name" placeholder="Item Name" class="flex-1 bg-white border-none rounded-lg shadow-sm px-3 py-2 text-xs focus:ring-2 focus:ring-primary/20"><input type="number" id="new-item-price" placeholder="Rate" class="w-16 bg-white border-none rounded-lg shadow-sm px-2 py-2 text-xs text-center focus:ring-2 focus:ring-primary/20"><button onclick="addNewItem()" class="bg-primary hover:bg-primaryDark text-white w-8 h-8 rounded-lg shadow-lg flex items-center justify-center transition-transform active:scale-95"><i class="fas fa-plus"></i></button></div>
                    </div>

                    <!-- Totals -->
                    <div class="totals-section">
                        <div class="w-full md:w-2/3 ml-auto">
                            <div class="flex justify-between items-center mb-2 pb-2 border-b border-gray-100"><span class="text-gray-500 font-medium text-xs">Subtotal</span><span class="text-base font-bold text-gray-800">₹ <span id="subtotal">0</span></span></div>
                            <div class="no-print gst-toggle-container mb-2 flex justify-end"><label class="inline-flex items-center cursor-pointer"><input type="checkbox" id="gst-toggle" class="sr-only peer" onchange="recalcGrandTotalsOnly()"><div class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary"></div><span class="ms-2 text-xs font-medium text-gray-900">GST (18%)</span></label></div>
                            <div id="tax-rows" class="space-y-1 mb-2 hidden">
                                <div class="flex justify-between items-center text-xs"><div class="flex items-center text-gray-500"><span>CGST (9%)</span></div><span class="font-medium text-gray-700">+ ₹ <span id="cgst-amt">0</span></span></div>
                                <div class="flex justify-between items-center text-xs"><div class="flex items-center text-gray-500"><span>SGST (9%)</span></div><span class="font-medium text-gray-700">+ ₹ <span id="sgst-amt">0</span></span></div>
                            </div>
                            <div class="bg-primary/5 rounded-xl p-3 flex justify-between items-center border border-primary/10 totals-final"><span class="text-primary font-bold uppercase tracking-wider text-xs">Grand Total</span><span class="text-xl font-bold text-primary">₹ <span id="final-total">0</span></span></div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="print-footer hide-print show-print">
                        <p>Thank you for your business!</p>
                        <div class="signatures"><div class="sig-line">Customer Sign</div><div class="sig-line">Shop Owner Sign</div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- === VIEW: SEARCH === -->
        <div id="view-search" class="flex-grow hidden px-4 pb-24 animate-fade-in w-full max-w-4xl mx-auto">
            <div class="bg-white p-2 rounded-2xl shadow-lg mb-6 sticky top-4 z-20 border border-gray-100">
                <div class="relative"><i class="fas fa-search absolute left-4 top-3.5 text-gray-400"></i><input type="text" id="search-query" class="w-full pl-12 pr-24 py-3 bg-gray-50 rounded-xl outline-none focus:bg-white focus:ring-2 focus:ring-primary/20 transition-all font-medium text-gray-700 text-sm" placeholder="Search name or phone..."><button onclick="performSearch()" id="btn-search" class="absolute right-1 top-1 bottom-1 bg-primary text-white px-5 rounded-lg font-bold shadow-md hover:bg-primaryDark transition-colors text-xs">Find</button></div>
            </div>
            <div id="search-results" class="space-y-4"><div class="flex flex-col items-center justify-center text-gray-300 mt-20"><i class="fas fa-receipt text-6xl mb-4 opacity-50"></i><p class="text-lg font-medium">Search for old bills</p></div></div>
        </div>
    </div>

    <!-- FAB -->
    <div class="fixed bottom-6 left-0 right-0 px-4 flex justify-center no-print z-40" id="fab-container"><button onclick="printAndSave()" id="btn-print" class="w-full max-w-md bg-gray-900 text-white py-4 rounded-2xl shadow-2xl font-bold text-lg flex items-center justify-center gap-3 transform transition-all hover:scale-[1.02] active:scale-95 border border-gray-700"><i class="fas fa-print text-primary-400"></i> <span id="save-btn-text">Print & Save Bill</span></button></div>

    <script>
        const DEFAULT_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrKvkCYR9nq_DIcUwp4Hed237yoYgvI4aTBMT_gEX-At2PzYOKz7RbO3ApyGoz9Kzc1g/exec"; 
        const DEFAULT_GSTIN = "24585435642"; 
        const STANDARD_RATE = 1500;
        const STANDARD_AREA = 15 * 15; 
        let items = [ { id: 1, name: 'Mattress (Gadda)', price: 50, qty: 0, days: 1 }, { id: 2, name: 'Pillow', price: 20, qty: 0, days: 1 }, { id: 3, name: 'Bedsheet', price: 30, qty: 0, days: 1 }, { id: 4, name: 'Plastic Chair', price: 10, qty: 0, days: 1 } ];
        let editingRowIndex = null;

        window.onload = function() {
            document.getElementById('current-date').innerText = new Date().toLocaleString('en-GB');
            document.getElementById('print-date-text').innerText = new Date().toLocaleDateString('en-GB');
            
            let savedUrl = localStorage.getItem('scriptUrl');
            if (!savedUrl && DEFAULT_SCRIPT_URL && DEFAULT_SCRIPT_URL.trim() !== "") { localStorage.setItem('scriptUrl', DEFAULT_SCRIPT_URL); savedUrl = DEFAULT_SCRIPT_URL; }
            if (savedUrl) document.getElementById('script-url').value = savedUrl;
            
            let gstin = localStorage.getItem('shopGstin');
            if (!gstin) { gstin = DEFAULT_GSTIN; localStorage.setItem('shopGstin', gstin); } 
            if (gstin) { document.getElementById('shop-gstin').value = gstin; updateGstinDisplay(gstin); }

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start-date').value = today;
            document.getElementById('end-date').value = today;
            updatePrintDates();
            renderTableRows();
            
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
        };

        function updateGstinDisplay(val) {
            const display = val ? `GSTIN: ${val}` : '';
            document.getElementById('print-gstin-display').innerText = display;
            document.getElementById('screen-gstin-display').innerText = display;
        }

        function recalcGrandTotalsOnly() {
            const globalDays = parseInt(document.getElementById('total-days').innerText) || 1;
            // Use OR 0 for calculation to handle empty inputs
            const l = parseFloat(document.getElementById('mandap-l').value) || 0;
            const w = parseFloat(document.getElementById('mandap-w').value) || 0;
            let mandapTotal = 0;
            const mandapSection = document.getElementById('mandap-section');
            
            if ((l*w) > 0) {
                const oneDayPrice = Math.round(((l*w) / STANDARD_AREA) * STANDARD_RATE);
                mandapTotal = oneDayPrice * globalDays;
                mandapSection.classList.remove('print:hidden');
            } else {
                mandapSection.classList.add('print:hidden');
            }
            
            document.getElementById('mandap-details').innerText = `Size: ${l}x${w} (${l*w} sq.ft) x ${globalDays} Days`;
            document.getElementById('mandap-price').innerText = mandapTotal;

            const itemsTotal = items.reduce((sum, item) => sum + (item.price * item.qty * item.days), 0);
            const subtotal = mandapTotal + itemsTotal;
            document.getElementById('subtotal').innerText = subtotal;

            const isGstEnabled = document.getElementById('gst-toggle').checked;
            const taxRows = document.getElementById('tax-rows');
            let cgstAmt = 0, sgstAmt = 0;

            if (isGstEnabled) {
                taxRows.classList.remove('hidden'); taxRows.classList.remove('no-tax-print');
                cgstAmt = Math.round((subtotal * 9) / 100); sgstAmt = Math.round((subtotal * 9) / 100);
            } else {
                taxRows.classList.add('hidden'); taxRows.classList.add('no-tax-print');
            }

            document.getElementById('cgst-amt').innerText = cgstAmt;
            document.getElementById('sgst-amt').innerText = sgstAmt;
            document.getElementById('final-total').innerText = subtotal + cgstAmt + sgstAmt;
        }

        function renderTableRows() {
            const tbody = document.getElementById('items-list');
            tbody.innerHTML = '';
            items.forEach((item, index) => {
                const itemTotal = item.price * item.qty * item.days;
                const tr = document.createElement('tr');
                tr.className = 'group hover:bg-gray-50 transition-colors';
                
                // Logic to display empty string if value is 0
                const priceVal = item.price === 0 ? '' : item.price;
                const qtyVal = item.qty === 0 ? '' : item.qty;
                const daysVal = item.days === 0 ? '' : item.days;

                tr.innerHTML = `<td class="p-2 pl-3 text-gray-700 font-medium">${item.name}</td><td class="p-1 text-center"><input type="number" oninput="handleRowInput(${index}, 'price', this.value)" value="${priceVal}" class="w-full text-center bg-transparent border-b border-gray-100 focus:border-primary outline-none p-1" placeholder="0"></td><td class="p-1 text-center"><input type="number" oninput="handleRowInput(${index}, 'qty', this.value)" value="${qtyVal}" class="w-full text-center bg-gray-100 rounded-lg p-1 focus:bg-white focus:ring-2 focus:ring-primary/20 outline-none font-bold text-primary" placeholder="0"></td><td class="p-1 text-center bg-yellow-50/50"><input type="number" oninput="handleRowInput(${index}, 'days', this.value)" value="${daysVal}" class="w-full text-center bg-transparent border-b border-yellow-200 focus:border-yellow-500 outline-none font-bold text-yellow-700 p-1" placeholder="0"></td><td class="p-2 pr-3 text-right font-bold text-gray-800">₹ <span id="item-total-${index}">${itemTotal}</span></td><td class="no-print text-center p-1"><button onclick="deleteItem(${index})" class="text-red-300 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-red-50 transition-colors"><i class="fas fa-trash-alt text-xs"></i></button></td>`;
                tbody.appendChild(tr);
            });
            recalcGrandTotalsOnly();
        }
        function handleRowInput(index, field, value) { 
            // Save as number (0 if empty)
            items[index][field] = parseFloat(value) || 0; 
            const newRowTotal = items[index].price * items[index].qty * items[index].days; 
            const span = document.getElementById(`item-total-${index}`); 
            if(span) span.innerText = newRowTotal; 
            recalcGrandTotalsOnly(); 
        }
        function addNewItem() { const name = document.getElementById('new-item-name').value; const price = document.getElementById('new-item-price').value; const globalDays = parseInt(document.getElementById('total-days').innerText) || 1; if (name && price) { items.push({ id: Date.now(), name, price: parseFloat(price), qty: 0, days: globalDays }); renderTableRows(); document.getElementById('new-item-name').value = ''; document.getElementById('new-item-price').value = ''; } }
        function deleteItem(index) { if(confirm('Remove?')) { items.splice(index, 1); renderTableRows(); } }

        function calcDays() {
            const startStr = document.getElementById('start-date').value; const endStr = document.getElementById('end-date').value;
            if(startStr && endStr) {
                const diffTime = new Date(endStr) - new Date(startStr);
                let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; if (diffDays < 1) diffDays = 1;
                document.getElementById('total-days').innerText = diffDays; document.getElementById('print-total-days').innerText = diffDays;
                updatePrintDates(); items.forEach(item => item.days = diffDays); renderTableRows();
            }
        }
        function updatePrintDates() {
            const s = new Date(document.getElementById('start-date').value); const e = new Date(document.getElementById('end-date').value);
            document.getElementById('print-start-date').innerText = s.toLocaleDateString('en-GB'); document.getElementById('print-end-date').innerText = e.toLocaleDateString('en-GB');
        }
        function switchTab(tab) {
            const newView = document.getElementById('view-new-bill'); const searchView = document.getElementById('view-search'); const fab = document.getElementById('fab-container');
            const activeClasses = ["bg-primary", "text-white", "shadow-md"]; const inactiveClasses = ["text-gray-500", "hover:bg-gray-50"];
            if(tab === 'new') {
                newView.classList.remove('hidden'); searchView.classList.add('hidden'); fab.classList.remove('hidden');
                document.getElementById('tab-new').classList.add(...activeClasses); document.getElementById('tab-new').classList.remove(...inactiveClasses);
                document.getElementById('tab-search').classList.remove(...activeClasses); document.getElementById('tab-search').classList.add(...inactiveClasses);
            } else {
                newView.classList.add('hidden'); searchView.classList.remove('hidden'); fab.classList.add('hidden');
                document.getElementById('tab-search').classList.add(...activeClasses); document.getElementById('tab-search').classList.remove(...inactiveClasses);
                document.getElementById('tab-new').classList.remove(...activeClasses); document.getElementById('tab-new').classList.add(...inactiveClasses);
                fetchRecent();
            }
        }
        function fetchRecent() { performSearch('recent'); }
        function toggleSettings() { const m = document.getElementById('settings-modal'); m.classList.toggle('hidden'); m.classList.toggle('flex'); }
        function saveSettings() { 
            localStorage.setItem('scriptUrl', document.getElementById('script-url').value); 
            const gstin = document.getElementById('shop-gstin').value;
            localStorage.setItem('shopGstin', gstin);
            updateGstinDisplay(gstin);
            toggleSettings(); showToast("Settings Saved!", "success"); 
        }
        function showToast(message, type) { const t = document.getElementById('toast'); const i = document.getElementById('toast-icon'); document.getElementById('toast-message').innerText = message; t.className = "fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 z-50 transition-all duration-300 min-w-[280px] justify-center text-white font-medium " + (type === 'success' ? 'bg-secondary' : type === 'error' ? 'bg-red-500' : 'bg-gray-900'); i.className = type === 'success' ? "fas fa-check-circle" : type === 'error' ? "fas fa-exclamation-circle" : "fas fa-info-circle"; t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 4000); }

        async function printAndSave() {
            const custName = document.getElementById('cust-name').value;
            if (!custName) { showToast("Enter Customer Name", "error"); return; }
            const btn = document.getElementById('btn-print');
            const originalText = btn.innerHTML;
            const scriptUrl = localStorage.getItem('scriptUrl') || DEFAULT_SCRIPT_URL;
            let printTriggered = false;
            const triggerPrint = () => { if(!printTriggered) { printTriggered = true; btn.innerHTML = originalText; window.print(); } };
            document.getElementById('current-date').innerText = new Date().toLocaleString('en-GB');
            document.getElementById('print-date-text').innerText = new Date().toLocaleDateString('en-GB');

            if (scriptUrl) {
                btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Saving...';
                setTimeout(triggerPrint, 2000); 
                
                let detailsArray = [];
                const mandapPriceVal = parseFloat(document.getElementById('mandap-price').innerText);
                if (mandapPriceVal > 0) { const l = document.getElementById('mandap-l').value; const w = document.getElementById('mandap-w').value; detailsArray.push(`MANDAP: ${l}x${w}ft (Rs ${mandapPriceVal})`); }
                items.forEach(i => { if(i.qty > 0) { detailsArray.push(`${i.name}: ${i.qty}pcs x ${i.days}days`); } });
                const finalDetailsString = detailsArray.join('\n');
                
                const payload = { 
                    action: editingRowIndex ? 'edit' : 'create', row: editingRowIndex, 
                    name: custName, phone: document.getElementById('cust-phone').value, 
                    startDate: document.getElementById('start-date').value, endDate: document.getElementById('end-date').value, 
                    days: document.getElementById('total-days').innerText, details: finalDetailsString, 
                    subtotal: document.getElementById('subtotal').innerText, 
                    cgst: document.getElementById('cgst-amt').innerText, sgst: document.getElementById('sgst-amt').innerText, 
                    total: document.getElementById('final-total').innerText 
                };
                try { await fetch(scriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); showToast(editingRowIndex ? "Updated!" : "Saved!", "success"); triggerPrint(); if(editingRowIndex) exitEditMode(); } 
                catch (error) { console.error(error); showToast("Network Error", "error"); triggerPrint(); }
            } else { showToast("Script URL Missing", "error"); triggerPrint(); }
        }

        async function performSearch(type = 'search') {
            const query = document.getElementById('search-query').value;
            const scriptUrl = localStorage.getItem('scriptUrl') || DEFAULT_SCRIPT_URL;
            const resultDiv = document.getElementById('search-results');
            
            if(!scriptUrl) { showToast("Setup settings first", "error"); return; }
            if(type === 'search' && !query) { showToast("Enter text", "error"); return; }
            
            resultDiv.innerHTML = '<div class="text-center mt-12"><i class="fas fa-circle-notch fa-spin text-3xl text-primary mb-3"></i><p class="text-gray-500 font-medium">Fetching Records...</p></div>';
            let url = `${scriptUrl}?q=${encodeURIComponent(query)}`; if(type === 'recent') url = `${scriptUrl}?type=recent`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                data.sort((a, b) => new Date(b.date) - new Date(a.date));
                resultDiv.innerHTML = '';
                if(data.length === 0) { resultDiv.innerHTML = '<div class="text-center text-gray-400 mt-12 py-10 bg-gray-50 rounded-2xl border border-dashed border-gray-200"><i class="far fa-folder-open text-4xl mb-2"></i><br>No records found</div>'; return; }
                
                data.forEach(bill => {
                    if(bill.name.toLowerCase() === 'name') return;
                    const isPaid = bill.status === 'Paid';
                    const displayDate = new Date(bill.date).toLocaleDateString('en-GB');
                    const dataStr = encodeURIComponent(JSON.stringify(bill));
                    
                    const html = `<div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow relative overflow-hidden group"><div class="absolute top-0 right-0 w-2 h-full ${isPaid ? 'bg-secondary' : 'bg-red-500'}"></div><div class="flex justify-between items-start mb-3 pr-4"><div><h3 class="font-bold text-gray-900 text-lg">${bill.name}</h3><div class="flex items-center gap-2 text-gray-500 text-sm mt-1"><i class="fas fa-phone-alt text-xs"></i> ${bill.phone}</div><div class="flex items-center gap-2 text-gray-400 text-xs mt-1"><i class="far fa-clock"></i> ${displayDate}</div></div><div class="text-right"><div class="text-xl font-bold text-gray-900">₹ ${bill.total}</div><span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold ${isPaid ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} mt-1"><i class="fas ${isPaid ? 'fa-check-circle' : 'fa-clock'}"></i> ${bill.status}</span></div></div><div class="flex gap-2 pt-3 border-t border-gray-50"><button onclick="editInvoice(${bill.rowIndex}, '${dataStr}')" class="flex-1 py-2 bg-blue-50 text-blue-600 rounded-lg text-sm font-bold flex items-center justify-center gap-2 hover:bg-blue-100 transition-colors"><i class="fas fa-pen"></i> Edit</button>${!isPaid ? `<button onclick="markAsPaid(${bill.rowIndex})" class="flex-1 py-2 bg-green-50 text-green-600 rounded-lg text-sm font-bold flex items-center justify-center gap-2 hover:bg-green-100 transition-colors"><i class="fas fa-check"></i> Paid</button>` : ''}<button onclick="deleteInvoice(${bill.rowIndex})" class="w-10 flex items-center justify-center bg-red-50 text-red-500 rounded-lg hover:bg-red-100 transition-colors"><i class="fas fa-trash-alt"></i></button></div></div>`;
                    resultDiv.insertAdjacentHTML('beforeend', html);
                });
            } catch(e) { console.error(e); resultDiv.innerHTML = '<div class="text-center text-red-400 mt-10">Error loading data.</div>'; }
        }

        async function editInvoice(rowIndex, dataStr) {
            const data = JSON.parse(decodeURIComponent(dataStr));
            editingRowIndex = rowIndex;
            document.getElementById('save-btn-text').innerText = "Update Invoice";
            document.getElementById('edit-mode-bar').classList.remove('hidden');
            document.getElementById('cust-name').value = data.name;
            document.getElementById('cust-phone').value = data.phone;
            try { document.getElementById('start-date').value = new Date(data.startDate).toISOString().split('T')[0]; document.getElementById('end-date').value = new Date(data.endDate).toISOString().split('T')[0]; } catch(e) {}
            calcDays();
            items.forEach(i => { i.qty = 0; i.days = 1; });
            document.getElementById('mandap-l').value = ''; // Blank instead of 0
            document.getElementById('mandap-w').value = ''; 
            const lines = data.details.split('\n');
            lines.forEach(line => {
                if (line.includes('MANDAP:')) { const match = line.match(/(\d+)x(\d+)ft/); if(match) { document.getElementById('mandap-l').value = match[1]; document.getElementById('mandap-w').value = match[2]; } }
                else { const parts = line.split(':'); if(parts.length > 1) { const name = parts[0].trim(); const nums = parts[1].match(/(\d+)pcs x (\d+)days/); if(nums) { const foundItem = items.find(i => i.name === name); if(foundItem) { foundItem.qty = parseInt(nums[1]); foundItem.days = parseInt(nums[2]); } else { items.push({ id: Date.now(), name: name, price: 0, qty: parseInt(nums[1]), days: parseInt(nums[2]) }); } } } }
            });
            document.getElementById('gst-toggle').checked = false;
            switchTab('new'); renderTableRows(); showToast("Invoice Loaded", "success");
        }

        async function deleteInvoice(rowIndex) {
            if(!confirm("Delete this invoice?")) return;
            const scriptUrl = localStorage.getItem('scriptUrl') || DEFAULT_SCRIPT_URL;
            try { await fetch(scriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'delete', row: rowIndex }) }); showToast("Deleted!", "success"); setTimeout(() => fetchRecent(), 1500); } catch(e) { showToast("Delete failed", "error"); }
        }
        
        async function markAsPaid(rowIndex) {
            if(!confirm("Mark as Paid?")) return;
            const scriptUrl = localStorage.getItem('scriptUrl') || DEFAULT_SCRIPT_URL;
            try { await fetch(scriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'mark_paid', row: rowIndex }) }); showToast("Paid!", "success"); setTimeout(() => fetchRecent(), 1000); } catch(e) { showToast("Update failed", "error"); }
        }

        function exitEditMode() { editingRowIndex = null; document.getElementById('save-btn-text').innerText = "Print & Save Bill"; document.getElementById('edit-mode-bar').classList.add('hidden'); document.getElementById('cust-name').value = ""; document.getElementById('cust-phone').value = ""; items.forEach(i => { i.qty = 0; i.days = 1; }); document.getElementById('mandap-l').value = ''; document.getElementById('mandap-w').value = ''; renderTableRows(); showToast("Edit cancelled", "info"); }
    </script>
</body>
</html>
