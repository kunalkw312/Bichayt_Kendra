<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bichayt Kendra Manager</title>
    
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Manage Bichayt Kendra Bills">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* === PRINT STYLES === */
        @media print {
            @page { size: A4; margin: 10mm; }
            body, html { background-color: white; margin: 0; padding: 0; font-size: 12pt; }
            .no-print, #tab-nav, #settings-modal, #toast, #btn-install, button { display: none !important; }
            #main-container { box-shadow: none !important; border: 2px solid black !important; width: 100% !important; margin: 0 !important; }
            .bg-blue-600 { background-color: #f3f3f3 !important; color: black !important; border-bottom: 2px solid black; padding: 15px !important; }
            .bg-yellow-50, .bg-blue-50, .bg-gray-50 { background-color: transparent !important; border: none !important; padding: 0 !important; margin-bottom: 10px !important; }
            .text-white { color: black !important; }
            table { width: 100% !important; border-collapse: collapse; }
            th, td { border-bottom: 1px solid #ddd; padding: 4px; }
            th { font-weight: bold; border-bottom: 2px solid black; }
            input { border: none !important; background: transparent !important; padding: 0 !important; height: auto !important; width: 100% !important; }
            input.text-center { text-align: center; } input.text-right { text-align: right; }
            ::placeholder { color: transparent; }
            .col-item { width: 40%; text-align: left; }
            .col-rate { width: 15%; text-align: center; }
            .col-qty { width: 10%; text-align: center; }
            .col-days { width: 10%; text-align: center; }
            .col-total { width: 25%; text-align: right; }
            .tax-input { display: none; }
            .tax-label-print { display: inline !important; }
        }
        .tax-label-print { display: none; }
    </style>
</head>
<body>

    <!-- TOAST -->
    <div id="toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-4 rounded-lg shadow-2xl text-white font-bold hidden transition-all duration-300 z-[100] no-print flex items-center gap-3 min-w-[300px] justify-center">
        <i id="toast-icon" class="text-xl"></i><span id="toast-message" class="text-sm"></span>
    </div>

    <!-- SETTINGS -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 no-print px-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <h2 class="text-xl font-bold mb-4">Settings</h2>
            <label class="block text-sm font-medium text-gray-700 mb-2">Google Web App URL</label>
            <input type="text" id="script-url" class="w-full p-3 border rounded mb-4" placeholder="https://script.google.com/...">
            <div class="flex justify-end gap-2">
                <button onclick="toggleSettings()" class="px-4 py-2 text-gray-600">Cancel</button>
                <button onclick="saveSettings()" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
            </div>
        </div>
    </div>

    <div class="min-h-screen p-2 md:p-6 flex flex-col">
        
        <!-- HEADER -->
        <div class="max-w-4xl w-full mx-auto mb-4 flex justify-between items-center no-print px-1">
            <h1 class="text-xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-store text-blue-600 mr-2"></i>
                <span class="hidden sm:inline">Bichayt Kendra</span>
                <span class="sm:hidden">Bichayt</span>
            </h1>
            <div class="flex gap-2">
                <button id="btn-install" class="hidden text-blue-600 font-bold text-xs bg-blue-50 px-3 py-1 rounded-full"><i class="fas fa-download mr-1"></i> App</button>
                <button onclick="toggleSettings()" class="text-gray-500 p-2"><i class="fas fa-cog text-xl"></i></button>
            </div>
        </div>

        <!-- TABS -->
        <div id="tab-nav" class="max-w-4xl w-full mx-auto mb-4 flex gap-2 no-print">
            <button onclick="switchTab('new')" id="tab-new" class="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold shadow text-sm">New Bill</button>
            <button onclick="switchTab('search')" id="tab-search" class="flex-1 py-3 bg-white text-gray-600 rounded-lg font-bold shadow hover:bg-gray-50 text-sm">Search Bills</button>
        </div>

        <!-- NEW BILL -->
        <div id="view-new-bill">
            <div id="main-container" class="max-w-4xl w-full mx-auto bg-white shadow-xl rounded-xl overflow-hidden print-border relative bg-white flex-grow">
                <div class="bg-blue-600 p-6 text-white">
                    <div class="flex justify-between items-start">
                        <div><h1 class="text-2xl font-bold uppercase tracking-wider">Invoice</h1><p class="text-sm opacity-90 mt-1">Bichayt Kendra & Events</p></div>
                        <div class="text-right"><div class="text-sm font-mono opacity-90" id="current-date">...</div></div>
                    </div>
                </div>

                <div class="p-4 md:p-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="space-y-4">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Customer Name</label><input type="text" id="cust-name" class="w-full text-base font-medium border-b-2 border-gray-200 focus:border-blue-500 outline-none py-1"></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Phone Number</label><input type="number" id="cust-phone" class="w-full text-base font-medium border-b-2 border-gray-200 focus:border-blue-500 outline-none py-1"></div>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                            <label class="block text-xs font-bold text-yellow-800 uppercase mb-2">Event Duration (Global)</label>
                            <div class="flex flex-col sm:flex-row gap-3 mb-2">
                                <div class="w-full"><span class="text-xs text-gray-500 block mb-1">Start Date</span><input type="date" id="start-date" onchange="calcDays()" class="w-full bg-white border rounded p-2 text-sm"></div>
                                <div class="w-full"><span class="text-xs text-gray-500 block mb-1">End Date</span><input type="date" id="end-date" onchange="calcDays()" class="w-full bg-white border rounded p-2 text-sm"></div>
                            </div>
                            <div class="text-right border-t border-yellow-200 pt-2"><span class="text-sm text-gray-600">Total Days:</span><span class="text-lg font-bold text-yellow-900 ml-1"><span id="total-days">1</span></span></div>
                        </div>
                    </div>

                    <div class="bg-blue-50 rounded-lg p-4 mb-6 border border-blue-100">
                        <h3 class="font-bold text-blue-800 mb-3 text-sm uppercase flex justify-between items-center">
                            <span><i class="fas fa-campground mr-2"></i> Mandap Area</span>
                            <span class="text-xs text-blue-600 font-normal bg-white px-2 py-1 rounded">Uses Global Days</span>
                        </h3>
                        <div class="grid grid-cols-3 gap-4 items-end">
                            <div><label class="block text-xs text-gray-600 mb-1">Length (ft)</label><input type="number" id="mandap-l" value="0" oninput="recalcGrandTotalsOnly()" class="w-full p-2 border rounded bg-white text-center font-bold"></div>
                            <div class="flex items-center justify-center pb-2 text-gray-400 font-bold">X</div>
                            <div><label class="block text-xs text-gray-600 mb-1">Width (ft)</label><input type="number" id="mandap-w" value="0" oninput="recalcGrandTotalsOnly()" class="w-full p-2 border rounded bg-white text-center font-bold"></div>
                        </div>
                        <div class="mt-3 flex justify-between items-center border-t border-blue-200 pt-3">
                            <div class="text-sm text-blue-700"><div id="mandap-details">Size: 0x0</div></div>
                            <div class="text-xl font-bold text-blue-900">₹ <span id="mandap-price">0</span></div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="font-bold text-gray-800 mb-3 text-sm uppercase">Items List</h3>
                        <div class="overflow-x-auto border rounded-lg border-gray-100">
                            <table class="w-full min-w-[600px]">
                                <thead class="bg-gray-50 border-b">
                                    <tr class="text-sm text-gray-500">
                                        <th class="p-3 text-left w-[40%] col-item">Item Name</th>
                                        <th class="p-3 text-center w-[15%] col-rate">Rate</th>
                                        <th class="p-3 text-center w-[10%] col-qty">Qty</th>
                                        <th class="p-3 text-center w-[10%] col-days bg-yellow-50/50">Days</th>
                                        <th class="p-3 text-right w-[20%] col-total">Total</th>
                                        <th class="p-3 w-[5%] no-print"></th>
                                    </tr>
                                </thead>
                                <tbody id="items-list"></tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex gap-2 no-print bg-gray-50 p-3 rounded-lg border border-dashed border-gray-300 items-center">
                            <input type="text" id="new-item-name" placeholder="Item Name" class="flex-1 p-2 border rounded text-base">
                            <input type="number" id="new-item-price" placeholder="Rate" class="w-24 p-2 border rounded text-base">
                            <button onclick="addNewItem()" class="bg-green-600 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-green-700 shadow-md flex-shrink-0"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>

                    <div class="flex justify-end border-t border-gray-200 pt-6">
                        <div class="w-full md:w-1/2">
                            <div class="flex justify-between mb-3 text-base text-gray-800 font-bold border-b border-gray-200 pb-2"><span>Subtotal</span><span>₹ <span id="subtotal">0</span></span></div>
                            <div class="flex justify-between mb-2 text-sm text-gray-600 items-center">
                                <div class="flex items-center"><span>CGST</span><input type="number" id="cgst-rate" value="9" readonly class="tax-input w-10 text-center border-b border-gray-300 mx-2 bg-gray-100 text-gray-500"><span class="tax-label-print ml-1">(<span id="cgst-print-rate">9</span>%)</span></div><span>+ ₹ <span id="cgst-amt">0</span></span>
                            </div>
                            <div class="flex justify-between mb-2 text-sm text-gray-600 items-center">
                                 <div class="flex items-center"><span>SGST</span><input type="number" id="sgst-rate" value="9" readonly class="tax-input w-10 text-center border-b border-gray-300 mx-2 bg-gray-100 text-gray-500"><span class="tax-label-print ml-1">(<span id="sgst-print-rate">9</span>%)</span></div><span>+ ₹ <span id="sgst-amt">0</span></span>
                            </div>
                            <div class="flex justify-between mt-4 pt-4 border-t-2 border-gray-800 text-2xl font-bold text-gray-900"><span>Grand Total</span><span>₹ <span id="final-total">0</span></span></div>
                        </div>
                    </div>

                    <div class="mt-12 pt-8 border-t border-gray-200 text-center hidden print:block">
                        <p class="text-xs text-gray-500 mb-12 italic">Please pay before due date. Thank you for your business!</p>
                        <div class="flex justify-between px-12"><div class="border-t border-black w-32 pt-2 text-xs font-bold uppercase">Customer Sign</div><div class="border-t border-black w-32 pt-2 text-xs font-bold uppercase">Shop Owner Sign</div></div>
                    </div>
                </div>
            </div>

            <div class="max-w-4xl w-full mx-auto mt-6 no-print pb-24">
                <button onclick="printAndSave()" id="btn-print" class="w-full bg-blue-600 text-white py-4 rounded-xl shadow-lg font-bold text-xl flex items-center justify-center hover:bg-blue-700 active:scale-95 transition-transform"><i class="fas fa-print mr-3"></i> Print & Save Bill</button>
            </div>
        </div>

        <!-- SEARCH VIEW -->
        <div id="view-search" class="hidden max-w-4xl w-full mx-auto">
            <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Search Old Bills</h2>
                <div class="flex gap-2"><input type="text" id="search-query" class="flex-1 border p-3 rounded-lg text-lg" placeholder="Customer Name or Phone..."><button onclick="performSearch()" id="btn-search" class="bg-blue-600 text-white px-6 rounded-lg font-bold">Search</button></div>
            </div>
            <div id="search-results" class="space-y-4 pb-24"><div class="text-center text-gray-400 mt-12 text-lg">Search to see records...</div></div>
        </div>

    </div>

    <script>
        // ==========================================
        // 1. PASTE YOUR GOOGLE SCRIPT URL BELOW
        // ==========================================
        const DEFAULT_SCRIPT_URL = ""; 
        // ==========================================

        const STANDARD_RATE = 1500;
        const STANDARD_AREA = 15 * 15; 
        
        let items = [ 
            { id: 1, name: 'Mattress (Gadda)', price: 50, qty: 0, days: 1 }, 
            { id: 2, name: 'Pillow', price: 20, qty: 0, days: 1 }, 
            { id: 3, name: 'Bedsheet', price: 30, qty: 0, days: 1 }, 
            { id: 4, name: 'Plastic Chair', price: 10, qty: 0, days: 1 } 
        ];
        
        // PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e;
            const installBtn = document.getElementById('btn-install');
            installBtn.classList.remove('hidden');
            installBtn.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') { installBtn.classList.add('hidden'); }
                    deferredPrompt = null;
                });
            });
        });
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); }); }

        window.onload = function() {
            document.getElementById('current-date').innerText = new Date().toLocaleString('en-GB');
            let savedUrl = localStorage.getItem('scriptUrl');
            if (!savedUrl && DEFAULT_SCRIPT_URL && DEFAULT_SCRIPT_URL !== "") { savedUrl = DEFAULT_SCRIPT_URL; localStorage.setItem('scriptUrl', savedUrl); }
            if (savedUrl) document.getElementById('script-url').value = savedUrl;
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start-date').value = today;
            document.getElementById('end-date').value = today;
            renderTableRows(); 
        };

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msg = document.getElementById('toast-message');
            msg.innerText = message;
            toast.className = "fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-4 rounded-lg shadow-2xl text-white font-bold transition-all duration-300 z-[100] no-print flex items-center gap-3 min-w-[300px] justify-center";
            if (type === 'success') { toast.classList.add('bg-green-600'); icon.className = "fas fa-check-circle"; } 
            else { toast.classList.add('bg-red-600'); icon.className = "fas fa-exclamation-triangle"; }
            toast.classList.remove('hidden'); setTimeout(() => { toast.classList.add('hidden'); }, 4000);
        }

        function switchTab(tab) {
            const newView = document.getElementById('view-new-bill');
            const searchView = document.getElementById('view-search');
            if(tab === 'new') {
                newView.classList.remove('hidden'); searchView.classList.add('hidden');
                document.getElementById('tab-new').classList.add('bg-blue-600', 'text-white');
                document.getElementById('tab-new').classList.remove('bg-white', 'text-gray-600');
                document.getElementById('tab-search').classList.remove('bg-blue-600', 'text-white');
            } else {
                newView.classList.add('hidden'); searchView.classList.remove('hidden');
                document.getElementById('tab-search').classList.add('bg-blue-600', 'text-white');
                document.getElementById('tab-search').classList.remove('bg-white', 'text-gray-600');
                document.getElementById('tab-new').classList.remove('bg-blue-600', 'text-white');
            }
        }

        function calcDays() {
            const startStr = document.getElementById('start-date').value;
            const endStr = document.getElementById('end-date').value;
            if(startStr && endStr) {
                const diffTime = new Date(endStr) - new Date(startStr);
                let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                if (diffDays < 1) diffDays = 1;
                document.getElementById('total-days').innerText = diffDays;
                items.forEach(item => item.days = diffDays);
                renderTableRows();
            }
        }

         function recalcGrandTotalsOnly() {
            const globalDays = parseInt(document.getElementById('total-days').innerText) || 1;
            const l = parseFloat(document.getElementById('mandap-l').value) || 0;
            const w = parseFloat(document.getElementById('mandap-w').value) || 0;
            let mandapTotal = 0;
            if ((l*w) > 0) {
                const oneDayPrice = Math.round(((l*w) / STANDARD_AREA) * STANDARD_RATE);
                mandapTotal = oneDayPrice * globalDays;
            }
            document.getElementById('mandap-details').innerText = `Size: ${l}x${w} (${l*w} sq.ft) x ${globalDays} Days`;
            document.getElementById('mandap-price').innerText = mandapTotal;
            const itemsTotal = items.reduce((sum, item) => sum + (item.price * item.qty * item.days), 0);
            const subtotal = mandapTotal + itemsTotal;
            document.getElementById('subtotal').innerText = subtotal;
            const cgstRate = 9; const sgstRate = 9;
            const cgstAmt = Math.round((subtotal * cgstRate) / 100);
            const sgstAmt = Math.round((subtotal * sgstRate) / 100);
            document.getElementById('cgst-amt').innerText = cgstAmt;
            document.getElementById('sgst-amt').innerText = sgstAmt;
            document.getElementById('final-total').innerText = subtotal + cgstAmt + sgstAmt;
        }

        function renderTableRows() {
            const tbody = document.getElementById('items-list');
            tbody.innerHTML = '';
            items.forEach((item, index) => {
                const itemTotal = item.price * item.qty * item.days;
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-50 hover:bg-gray-50 group';
                tr.innerHTML = `<td class="p-3 text-gray-700 col-item text-base font-medium">${item.name}</td><td class="p-3 text-center col-rate"><input type="number" oninput="handleRowInput(${index}, 'price', this.value)" value="${item.price}" class="w-full text-center bg-transparent border-b border-gray-200 focus:border-blue-500 outline-none text-base"></td><td class="p-3 text-center col-qty"><input type="number" oninput="handleRowInput(${index}, 'qty', this.value)" value="${item.qty}" class="w-full text-center bg-gray-100 rounded p-1 focus:bg-white border-none outline-none text-base font-bold"></td><td class="p-3 text-center bg-yellow-50/30 col-days"><input type="number" oninput="handleRowInput(${index}, 'days', this.value)" value="${item.days}" class="w-full text-center bg-transparent border-b border-yellow-300 focus:border-yellow-600 outline-none font-bold text-yellow-800 text-base"></td><td class="p-3 text-right font-bold text-gray-800 col-total text-base">₹ <span id="item-total-${index}">${itemTotal}</span></td><td class="no-print text-center p-3"><button onclick="deleteItem(${index})" class="text-red-300 hover:text-red-500 text-lg"><i class="fas fa-trash"></i></button></td>`;
                tbody.appendChild(tr);
            });
            recalcGrandTotalsOnly();
        }

        function handleRowInput(index, field, value) { items[index][field] = parseFloat(value) || 0; const newRowTotal = items[index].price * items[index].qty * items[index].days; const span = document.getElementById(`item-total-${index}`); if(span) span.innerText = newRowTotal; recalcGrandTotalsOnly(); }
        function addNewItem() { const name = document.getElementById('new-item-name').value; const price = document.getElementById('new-item-price').value; const globalDays = parseInt(document.getElementById('total-days').innerText) || 1; if (name && price) { items.push({ id: Date.now(), name, price: parseFloat(price), qty: 0, days: globalDays }); renderTableRows(); document.getElementById('new-item-name').value = ''; document.getElementById('new-item-price').value = ''; } }
        function deleteItem(index) { if(confirm('Remove?')) { items.splice(index, 1); renderTableRows(); } }
        function toggleSettings() { const m = document.getElementById('settings-modal'); m.classList.toggle('hidden'); m.classList.toggle('flex'); }
        function saveSettings() { localStorage.setItem('scriptUrl', document.getElementById('script-url').value); toggleSettings(); showToast("Settings Saved!", "success"); }
        
        async function printAndSave() {
            const custName = document.getElementById('cust-name').value;
            if (!custName) { showToast("Please enter Customer Name!", "error"); return; }
            const btn = document.getElementById('btn-print');
            const originalText = btn.innerHTML;
            const scriptUrl = localStorage.getItem('scriptUrl') || DEFAULT_SCRIPT_URL;
            
            let printTriggered = false;
            const triggerPrint = () => { if(!printTriggered) { printTriggered = true; btn.innerHTML = originalText; window.print(); } };
            
            document.getElementById('current-date').innerText = new Date().toLocaleString('en-GB');

            if (scriptUrl) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';
                setTimeout(triggerPrint, 1500); 
                
                // 1. COLLECT ALL DETAILS into one array
                let detailsArray = [];
                
                // Add Mandap if used
                const mandapPriceVal = parseFloat(document.getElementById('mandap-price').innerText);
                if (mandapPriceVal > 0) {
                    const l = document.getElementById('mandap-l').value;
                    const w = document.getElementById('mandap-w').value;
                    detailsArray.push(`MANDAP: ${l}x${w}ft (Rs ${mandapPriceVal})`);
                }
                
                // Add Items
                items.forEach(i => {
                    if(i.qty > 0) {
                        // Formatting: "Chair: 50pcs x 3days"
                        detailsArray.push(`${i.name}: ${i.qty}pcs x ${i.days}days`);
                    }
                });
                
                // Join with newline character
                const finalDetailsString = detailsArray.join('\n');

                const payload = {
                    action: 'create', name: custName, phone: document.getElementById('cust-phone').value,
                    startDate: document.getElementById('start-date').value, endDate: document.getElementById('end-date').value,
                    days: document.getElementById('total-days').innerText, 
                    details: finalDetailsString, // Uses new logic
                    subtotal: document.getElementById('subtotal').innerText, cgst: document.getElementById('cgst-amt').innerText,
                    sgst: document.getElementById('sgst-amt').innerText, total: document.getElementById('final-total').innerText
                };
                try { await fetch(scriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); showToast("Bill Saved Successfully!", "success"); triggerPrint(); } 
                catch (error) { console.error(error); showToast("Network Error!", "error"); triggerPrint(); }
            } else { showToast("No Script URL!", "error"); triggerPrint(); }
        }

        async function performSearch() {
            const query = document.getElementById('search-query').value;
            const scriptUrl = localStorage.getItem('scriptUrl') || DEFAULT_SCRIPT_URL;
            const resultDiv = document.getElementById('search-results');
            const btn = document.getElementById('btn-search');
            if(!scriptUrl) { alert("Please set URL in settings"); return; }
            if(!query) { alert("Enter text to search"); return; }
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; resultDiv.innerHTML = '';
            try {
                const response = await fetch(`${scriptUrl}?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                if(data.length === 0) { resultDiv.innerHTML = '<div class="text-center text-gray-500">No results found</div>'; } 
                else {
                    data.forEach(bill => {
                        const isPaid = bill.status === 'Paid';
                        const statusColor = isPaid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        const displayDate = new Date(bill.date).toLocaleString('en-GB');
                        // Replace newline with HTML break for display in search results
                        const displayDetails = (bill.details || 'No details').replace(/\n/g, '<br>');
                        
                        const html = `<div class="bg-white p-5 rounded-lg shadow border-l-4 ${isPaid ? 'border-green-500' : 'border-red-500'}"><div class="flex justify-between items-start"><div><h3 class="font-bold text-lg">${bill.name}</h3><p class="text-gray-600 text-sm"><i class="fas fa-phone mr-1"></i> ${bill.phone}</p><p class="text-gray-500 text-xs mt-1">${displayDate}</p></div><div class="text-right"><div class="text-xl font-bold">₹ ${bill.total}</div><span class="inline-block px-2 py-1 rounded text-xs font-bold ${statusColor} mt-1">${bill.status}</span></div></div><div class="mt-3 text-sm text-gray-500 bg-gray-50 p-2 rounded leading-relaxed">${displayDetails}</div>${!isPaid ? `<button onclick="markAsPaid(this, ${bill.rowIndex})" class="mt-3 w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700"><i class="fas fa-check-circle mr-2"></i> Mark as Paid</button>` : ''}</div>`;
                        resultDiv.insertAdjacentHTML('beforeend', html);
                    });
                }
            } catch(e) { console.error(e); alert("Search failed."); }
            btn.innerHTML = 'Search';
        }
        async function markAsPaid(btn, rowIndex) {
            if(!confirm("Are you sure?")) return;
            const scriptUrl = localStorage.getItem('scriptUrl') || DEFAULT_SCRIPT_URL;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Updating...';
            try {
                await fetch(scriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'mark_paid', row: rowIndex }) });
                btn.parentElement.classList.remove('border-red-500'); btn.parentElement.classList.add('border-green-500');
                btn.parentElement.querySelector('.bg-red-100').className = 'inline-block px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-800 mt-1';
                btn.parentElement.querySelector('.bg-green-100').innerText = 'Paid'; btn.remove();
                showToast("Marked as Paid!", "success");
            } catch(e) { showToast("Error updating status.", "error"); btn.innerHTML = originalText; }
        }
    </script>
</body>
</html>
